<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Sabhar â¤ï¸</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=Playfair+Display:ital,wght@0,500;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--pink:#e8637a;--pink-light:#fdeef1;--pink-mid:#f5b8c4;--bg:#fff9fa;--white:#fff;--text:#2d2d2d;--muted:#aaa;--border:#f0e0e4}
body{font-family:'DM Sans',sans-serif;background:var(--bg);height:100dvh;overflow:hidden;color:var(--text)}

/* LOGIN */
#loginScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--white);z-index:100;padding:30px;transition:opacity .5s,transform .5s}
#loginScreen.out{opacity:0;transform:translateY(-18px);pointer-events:none}
.login-logo{font-family:'Playfair Display',serif;font-size:3rem;color:var(--pink);margin-bottom:6px}
.login-tagline{font-size:.78rem;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:44px}
.tab-row{display:flex;background:var(--pink-light);border-radius:12px;padding:4px;width:100%;max-width:320px;margin-bottom:20px;gap:4px}
.tab{flex:1;padding:10px;border:none;border-radius:9px;background:transparent;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#b07080;cursor:pointer;transition:all .2s}
.tab.active{background:var(--white);color:var(--pink);font-weight:500;box-shadow:0 2px 8px rgba(232,99,122,.12)}
.pass-input{width:100%;max-width:320px;padding:14px 18px;border:1.5px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:1rem;color:var(--text);background:var(--white);outline:none;transition:border-color .2s;letter-spacing:4px;margin-bottom:14px;display:block}
.pass-input::placeholder{letter-spacing:1px;color:#ccc}
.pass-input:focus{border-color:var(--pink)}
.login-btn{width:100%;max-width:320px;padding:14px;background:var(--pink);border:none;border-radius:12px;color:white;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:500;cursor:pointer;box-shadow:0 4px 16px rgba(232,99,122,.28);transition:all .2s}
.login-btn:active{transform:scale(.98)}
.err{margin-top:12px;font-size:.82rem;color:var(--pink);font-style:italic;min-height:18px;text-align:center;max-width:320px}
.shake{animation:sh .35s ease}
@keyframes sh{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

/* CHAT */
#chatScreen{display:none;flex-direction:column;height:100dvh;background:var(--bg)}
#chatScreen.show{display:flex}
.header{background:var(--white);border-bottom:1px solid var(--border);padding:12px 16px;flex-shrink:0}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.header-title{font-family:'Playfair Display',serif;font-size:1.35rem;color:var(--pink);font-style:italic}
.header-right{display:flex;align-items:center;gap:8px}
.hbtn{background:none;border:1px solid var(--border);border-radius:8px;font-size:.72rem;color:var(--muted);cursor:pointer;padding:4px 10px}

/* Video call button in header */
.vcall-btn{background:linear-gradient(135deg,var(--pink),#f0a0b0);border:none;border-radius:10px;color:white;font-size:.8rem;font-weight:500;cursor:pointer;padding:7px 13px;display:flex;align-items:center;gap:5px;box-shadow:0 3px 10px rgba(232,99,122,.3);transition:all .2s;font-family:'DM Sans',sans-serif}
.vcall-btn:active{transform:scale(.96)}

/* Profile strip */
.profile-strip{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.profile-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer}
.profile-pic{width:44px;height:44px;border-radius:50%;border:2px solid var(--pink-mid);background:var(--pink-light);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--pink);font-weight:600;overflow:hidden;flex-shrink:0}
.profile-pic img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.profile-name{font-size:.68rem;color:var(--muted)}
.profile-edit-hint{font-size:.6rem;color:var(--pink-mid)}
.profile-hearts{font-size:1.2rem;margin:0 4px}

/* Ann card */
.ann-card{background:linear-gradient(135deg,#fff0f3,#fff8fa);border:1px solid #f5c6d0;border-radius:14px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.ann-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:3px}
.ann-names{font-family:'Playfair Display',serif;font-size:1rem;color:var(--pink);margin-bottom:3px}
.ann-sub{font-size:.72rem;color:#c08090}
.ann-milestone{font-size:.72rem;color:var(--pink);font-weight:500;margin-top:2px}
.ann-right{text-align:right;flex-shrink:0}
.ann-days{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--pink);line-height:1;margin-bottom:2px}
.ann-days-lbl{font-size:.62rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.ann-next{font-size:.68rem;color:var(--pink);margin-top:4px;font-weight:500}

/* Messages */
.msgs{flex:1;overflow-y:auto;padding:14px 12px;display:flex;flex-direction:column;gap:7px;scroll-behavior:smooth}
.msgs::-webkit-scrollbar{width:3px}
.msgs::-webkit-scrollbar-thumb{background:var(--pink-mid);border-radius:2px}
.day-lbl{text-align:center;font-size:.7rem;color:var(--muted);letter-spacing:1px;margin:4px 0 8px}
.msg-row{display:flex;align-items:flex-end;gap:7px;animation:up .22s ease;position:relative}
@keyframes up{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
.msg-row.me{flex-direction:row-reverse}
.av{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:white;overflow:hidden;border:1.5px solid var(--pink-mid);background:var(--pink-light)}
.av.me-av{border-color:var(--pink)}
.bwrap{position:relative;max-width:72%}
.bubble{padding:10px 13px;border-radius:16px;font-size:.91rem;line-height:1.5;word-break:break-word;cursor:pointer}
.bubble.me{background:var(--pink);color:white;border-bottom-right-radius:4px}
.bubble.her{background:var(--white);color:var(--text);border:1px solid var(--border);border-bottom-left-radius:4px}
.bt{font-size:.6rem;opacity:.5;display:block;margin-top:3px}
.bubble.me .bt{text-align:right}
.react-dot{position:absolute;bottom:-9px;right:5px;font-size:13px;background:white;border-radius:10px;padding:1px 4px;border:1px solid var(--border);line-height:1.4;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.bimg{max-width:200px;max-height:160px;border-radius:10px;display:block;cursor:pointer;margin-top:3px}
.bvid{max-width:200px;border-radius:10px;display:block;margin-top:3px}
.vmsg{display:flex;align-items:center;gap:8px;min-width:130px}
.vplay{background:rgba(255,255,255,.25);border:none;border-radius:50%;width:28px;height:28px;color:white;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center}
.bubble.her .vplay{background:var(--pink-light);color:var(--pink)}
.vwave{flex:1;height:20px;display:flex;align-items:center;gap:2px}
.vwave span{display:block;width:2px;background:rgba(255,255,255,.55);border-radius:2px;animation:wv 1.1s ease-in-out infinite}
.bubble.her .vwave span{background:var(--pink-mid)}
@keyframes wv{0%,100%{height:3px}50%{height:15px}}

/* MSG MENU */
.msg-menu{position:fixed;z-index:500;background:var(--white);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);overflow:hidden;min-width:150px;animation:popIn .15s ease}
@keyframes popIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.msg-menu button{display:block;width:100%;padding:11px 16px;background:none;border:none;text-align:left;font-family:'DM Sans',sans-serif;font-size:.88rem;cursor:pointer;color:var(--text)}
.msg-menu button:active{background:var(--pink-light)}
.msg-menu button.del{color:#d00}
.msg-menu .divider{height:1px;background:var(--border)}

/* Typing */
.typing-bar{padding:3px 14px;min-height:20px;flex-shrink:0}
.ttext{font-size:.73rem;color:var(--muted);font-style:italic;display:none}
.ttext.show{display:block}
.tdots{display:inline-flex;gap:3px;margin-left:4px;vertical-align:middle}
.tdots span{width:4px;height:4px;border-radius:50%;background:var(--pink-mid);display:inline-block;animation:td 1.1s infinite}
.tdots span:nth-child(2){animation-delay:.18s}.tdots span:nth-child(3){animation-delay:.36s}
@keyframes td{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-4px);opacity:1}}

/* Input bar */
.input-bar{background:var(--white);border-top:1px solid var(--border);padding:9px 11px;display:flex;align-items:flex-end;gap:7px;flex-shrink:0}
.ibtn{width:39px;height:39px;border:1.5px solid var(--border);border-radius:11px;background:var(--white);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;flex-shrink:0;transition:background .15s}
.ibtn:active{background:var(--pink-light)}
.tinput{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:20px;font-family:'DM Sans',sans-serif;font-size:.91rem;color:var(--text);background:var(--bg);outline:none;resize:none;min-height:39px;max-height:110px;line-height:1.45;transition:border-color .2s}
.tinput:focus{border-color:var(--pink-mid)}
.tinput::placeholder{color:#ccc}
.vbtn{width:39px;height:39px;border:1.5px solid var(--border);border-radius:11px;background:var(--white);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;flex-shrink:0;user-select:none}
.vbtn.rec{background:#fdeef1;border-color:var(--pink);animation:pulse .9s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(232,99,122,.3)}50%{box-shadow:0 0 0 7px rgba(232,99,122,0)}}
.sbtn{width:39px;height:39px;background:var(--pink);border:none;border-radius:11px;color:white;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(232,99,122,.28);transition:transform .15s}
.sbtn:active{transform:scale(.93)}
#fileIn,#picInHarsh,#picInSabu{display:none}

/* Emoji */
.etray{position:fixed;bottom:65px;left:11px;background:white;border:1px solid var(--border);border-radius:16px;padding:10px 12px;display:none;flex-wrap:wrap;gap:6px;max-width:250px;box-shadow:0 4px 18px rgba(0,0,0,.07);z-index:50}
.etray.show{display:flex}
.ep{background:none;border:none;font-size:21px;cursor:pointer}

/* â”€â”€ VIDEO CALL SCREEN â”€â”€ */
#vcScreen{
  display:none;position:fixed;inset:0;
  background:#0d0d0d;z-index:300;
  flex-direction:column;
}
#vcScreen.show{display:flex}

.vc-videos{
  flex:1;position:relative;overflow:hidden;
}

/* Remote video â€” fills screen */
#remoteVideo{
  width:100%;height:100%;
  object-fit:cover;
  background:#1a1a1a;
  display:block;
}

/* Local video â€” small PiP corner */
#localVideo{
  position:absolute;
  top:14px;right:14px;
  width:100px;height:140px;
  border-radius:14px;
  object-fit:cover;
  border:2px solid rgba(255,255,255,.3);
  background:#333;
  box-shadow:0 4px 16px rgba(0,0,0,.5);
  z-index:10;
}

/* Call status overlay */
.vc-status{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  background:rgba(13,13,13,.85);
  z-index:5;
  transition:opacity .4s;
}
.vc-status.hidden{opacity:0;pointer-events:none}
.vc-avatar-big{
  width:90px;height:90px;border-radius:50%;
  border:3px solid var(--pink);
  background:var(--pink-light);
  display:flex;align-items:center;justify-content:center;
  font-size:36px;font-weight:700;color:var(--pink);
  overflow:hidden;margin-bottom:16px;
}
.vc-avatar-big img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.vc-name{font-family:'Playfair Display',serif;font-size:1.4rem;color:white;margin-bottom:8px}
.vc-stat{font-size:.85rem;color:rgba(255,255,255,.5);letter-spacing:1px}
.vc-pulse{animation:vcpulse 1.5s infinite}
@keyframes vcpulse{0%,100%{box-shadow:0 0 0 0 rgba(232,99,122,.5)}50%{box-shadow:0 0 0 16px rgba(232,99,122,0)}}

/* Incoming call screen */
#incomingScreen{
  display:none;position:fixed;inset:0;
  background:rgba(13,13,13,.95);
  z-index:400;flex-direction:column;
  align-items:center;justify-content:center;
}
#incomingScreen.show{display:flex}
.inc-avatar{width:90px;height:90px;border-radius:50%;border:3px solid var(--pink);background:var(--pink-light);display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;color:var(--pink);overflow:hidden;margin-bottom:16px;animation:vcpulse 1.2s infinite}
.inc-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.inc-name{font-family:'Playfair Display',serif;font-size:1.5rem;color:white;margin-bottom:6px}
.inc-sub{font-size:.85rem;color:rgba(255,255,255,.5);margin-bottom:40px;letter-spacing:1px}
.inc-btns{display:flex;gap:40px}
.inc-accept{width:64px;height:64px;border-radius:50%;background:#22c55e;border:none;font-size:26px;cursor:pointer;box-shadow:0 4px 20px rgba(34,197,94,.4);transition:transform .15s}
.inc-reject{width:64px;height:64px;border-radius:50%;background:#ef4444;border:none;font-size:26px;cursor:pointer;box-shadow:0 4px 20px rgba(239,68,68,.4);transition:transform .15s}
.inc-accept:active,.inc-reject:active{transform:scale(.92)}

/* Call controls bar */
.vc-controls{
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(12px);
  padding:16px 24px 24px;
  display:flex;align-items:center;justify-content:center;
  gap:20px;flex-shrink:0;
}
.vc-ctrl{
  width:52px;height:52px;border-radius:50%;border:none;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;cursor:pointer;transition:all .2s;
  background:rgba(255,255,255,.12);color:white;
}
.vc-ctrl:active{transform:scale(.9)}
.vc-ctrl.muted{background:rgba(255,255,255,.25)}
.vc-ctrl.off{background:rgba(255,255,255,.08);opacity:.5}
.vc-end{background:#ef4444 !important;box-shadow:0 4px 16px rgba(239,68,68,.4) !important}
.vc-timer{color:rgba(255,255,255,.6);font-size:.85rem;min-width:50px;text-align:center}

/* Modals */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal-box{background:white;border-radius:20px;padding:28px 24px;max-width:340px;width:100%;text-align:center}
.modal-box h3{font-family:'Playfair Display',serif;color:var(--pink);font-size:1.3rem;margin-bottom:10px}
.modal-box p{font-size:.88rem;color:var(--text);line-height:1.6;margin-bottom:18px}
.modal-steps{text-align:left;font-size:.83rem;color:#555;line-height:2;margin-bottom:20px}
.modal-steps b{color:var(--pink)}
.modal-close{background:var(--pink);border:none;border-radius:10px;color:white;padding:11px 28px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}

/* Profile modal */
.prof-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;display:none;align-items:center;justify-content:center;padding:20px}
.prof-modal.show{display:flex}
.prof-box{background:white;border-radius:20px;padding:28px 24px;max-width:320px;width:100%}
.prof-box h3{font-family:'Playfair Display',serif;color:var(--pink);margin-bottom:20px;text-align:center}
.prof-preview{width:90px;height:90px;border-radius:50%;border:3px solid var(--pink-mid);object-fit:cover;display:block;margin:0 auto 16px;background:var(--pink-light)}
.prof-btns{display:flex;gap:10px;flex-direction:column}
.prof-choose{background:var(--pink-light);border:1.5px solid var(--pink-mid);border-radius:10px;color:var(--pink);padding:11px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}
.prof-save{background:var(--pink);border:none;border-radius:10px;color:white;padding:11px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}
.prof-close-btn{background:none;border:1px solid var(--border);border-radius:10px;color:var(--muted);padding:11px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}

/* Lightbox */
#lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center}
#lb.show{display:flex}
#lbImg{max-width:92vw;max-height:88vh;border-radius:12px}
.lbx{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.12);border:none;border-radius:50%;width:38px;height:38px;color:white;font-size:17px;cursor:pointer}

/* Toast */
.toast{position:fixed;top:14px;left:50%;transform:translateX(-50%) translateY(-65px);background:var(--pink);color:white;font-size:.83rem;padding:9px 20px;border-radius:30px;z-index:9999;transition:transform .4s cubic-bezier(.34,1.56,.64,1);white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}
.hpop{position:fixed;pointer-events:none;z-index:9999;font-size:17px;animation:hp .8s ease forwards}
@keyframes hp{0%{opacity:1;transform:translate(0,0) scale(.4)}60%{opacity:1;transform:translate(var(--tx),var(--ty)) scale(1)}100%{opacity:0;transform:translate(calc(var(--tx)*1.4),calc(var(--ty)*1.4 + 18px)) scale(.5)}}
</style>
</head>
<body>

<!-- Lightbox -->
<div id="lb"><img id="lbImg" src="" alt=""><button class="lbx" onclick="closeLb()">âœ•</button></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Mic/Cam permission modal -->
<div class="modal-overlay" id="permModal">
  <div class="modal-box">
    <h3>ğŸ“· Allow Camera & Mic</h3>
    <p>To video call, allow camera and microphone access in your browser settings.</p>
    <div class="modal-steps">
      <b>Chrome / Edge:</b><br>
      1. Tap ğŸ”’ lock icon in address bar<br>
      2. Set <b>Camera</b> & <b>Microphone â†’ Allow</b><br><br>
      <b>Safari (iPhone):</b><br>
      1. <b>Settings â†’ Safari â†’ Camera & Mic â†’ Allow</b><br><br>
      Then try the video call again! ğŸ“¹
    </div>
    <button class="modal-close" onclick="document.getElementById('permModal').classList.remove('show')">Got it â¤ï¸</button>
  </div>
</div>

<!-- Profile modal -->
<div class="prof-modal" id="profModal">
  <div class="prof-box">
    <h3 id="profTitle">Profile Photo</h3>
    <img class="prof-preview" id="profPreview" src="" alt="">
    <div class="prof-btns">
      <button class="prof-choose" onclick="chooseProfPic()">ğŸ“· Choose Photo</button>
      <button class="prof-save" onclick="saveProfPic()">Save â¤ï¸</button>
      <button class="prof-close-btn" onclick="closeProfModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- INCOMING CALL -->
<div id="incomingScreen">
  <div class="inc-avatar" id="incAvatar"><span id="incAvatarText"></span></div>
  <div class="inc-name" id="incName"></div>
  <div class="inc-sub">ğŸ“¹ Video Call</div>
  <div class="inc-btns">
    <button class="inc-accept" onclick="acceptCall()">ğŸ“</button>
    <button class="inc-reject" onclick="rejectCall()">ğŸ“µ</button>
  </div>
</div>

<!-- VIDEO CALL SCREEN -->
<div id="vcScreen">
  <div class="vc-videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo"  autoplay playsinline muted></video>
    <!-- Waiting overlay -->
    <div class="vc-status" id="vcStatus">
      <div class="vc-avatar-big vc-pulse" id="vcStatusAv"><span id="vcStatusAvTxt"></span></div>
      <div class="vc-name" id="vcStatusName"></div>
      <div class="vc-stat" id="vcStatusTxt">Connecting...</div>
    </div>
  </div>
  <div class="vc-controls">
    <button class="vc-ctrl" id="btnMic"   onclick="toggleMic()"  title="Mute">ğŸ™ï¸</button>
    <button class="vc-ctrl vc-end"        onclick="endCall()"    title="End">ğŸ“µ</button>
    <button class="vc-ctrl" id="btnCam"   onclick="toggleCam()"  title="Camera">ğŸ“·</button>
    <span class="vc-timer" id="vcTimer">00:00</span>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-logo">Sabhar â¤ï¸</div>
  <div class="login-tagline">just for us</div>
  <div class="tab-row">
    <button class="tab active" onclick="pickUser('harsh')">Harsh ğŸ’™</button>
    <button class="tab" onclick="pickUser('sabu')">Sabu ğŸŒ¸</button>
  </div>
  <input type="password" class="pass-input" id="passIn" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
  <button class="login-btn" onclick="doLogin()">Enter Our Space â¤ï¸</button>
  <div class="err" id="errMsg"></div>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <div class="header">
    <div class="header-top">
      <div class="header-title">Sabhar â¤ï¸</div>
      <div class="header-right">
        <button class="vcall-btn" onclick="startVideoCall()">ğŸ“¹ Video Call</button>
        <button class="hbtn" onclick="logout()">Leave</button>
      </div>
    </div>
    <div class="profile-strip">
      <div class="profile-item" onclick="openProfModal('harsh')">
        <div class="profile-pic" id="avHarsh"><span id="avHarshTxt">H</span></div>
        <div class="profile-name">Harsh</div>
        <div class="profile-edit-hint">tap to edit</div>
      </div>
      <div style="flex:1;text-align:center">
        <div class="profile-hearts">â¤ï¸</div>
        <div style="font-size:.6rem;color:var(--muted);letter-spacing:1px">FOREVER</div>
      </div>
      <div class="profile-item" onclick="openProfModal('sabu')">
        <div class="profile-pic" id="avSabu"><span id="avSabuTxt">S</span></div>
        <div class="profile-name">Saburi</div>
        <div class="profile-edit-hint">tap to edit</div>
      </div>
    </div>
    <div class="ann-card">
      <div>
        <div class="ann-label">Our Anniversary</div>
        <div class="ann-names">Harsh &amp; Saburi</div>
        <div class="ann-sub">ğŸ“… 29 October 2022</div>
        <div class="ann-milestone" id="milestone"></div>
      </div>
      <div class="ann-right">
        <div class="ann-days" id="daysCnt">â€”</div>
        <div class="ann-days-lbl">days together</div>
        <div class="ann-next" id="nextAnn"></div>
      </div>
    </div>
  </div>

  <div class="msgs" id="msgs">
    <div class="day-lbl">âœ¨ Your story begins here âœ¨</div>
  </div>

  <div class="typing-bar">
    <span class="ttext" id="ttext">typing <span class="tdots"><span></span><span></span><span></span></span></span>
  </div>

  <div class="etray" id="etray">
    <button class="ep" onclick="ei('â¤ï¸')">â¤ï¸</button>
    <button class="ep" onclick="ei('ğŸ˜˜')">ğŸ˜˜</button>
    <button class="ep" onclick="ei('ğŸ’•')">ğŸ’•</button>
    <button class="ep" onclick="ei('ğŸ¥°')">ğŸ¥°</button>
    <button class="ep" onclick="ei('ğŸ˜')">ğŸ˜</button>
    <button class="ep" onclick="ei('ğŸ˜Š')">ğŸ˜Š</button>
    <button class="ep" onclick="ei('ğŸŒ¹')">ğŸŒ¹</button>
    <button class="ep" onclick="ei('ğŸ’‹')">ğŸ’‹</button>
    <button class="ep" onclick="ei('âœ¨')">âœ¨</button>
    <button class="ep" onclick="ei('ğŸ¤—')">ğŸ¤—</button>
    <button class="ep" onclick="ei('ğŸ«¶')">ğŸ«¶</button>
    <button class="ep" onclick="ei('ğŸŒ¸')">ğŸŒ¸</button>
  </div>

  <div class="input-bar">
    <button class="ibtn" onclick="toggleE()">ğŸ˜Š</button>
    <button class="ibtn" onclick="document.getElementById('fileIn').click()">ğŸ“</button>
    <input type="file" id="fileIn" accept="image/*,video/*" onchange="onFile(event)">
    <input type="file" id="picInHarsh" accept="image/*" onchange="onPicChosen(event)">
    <input type="file" id="picInSabu"  accept="image/*" onchange="onPicChosen(event)">
    <textarea class="tinput" id="msgBox" placeholder="Message..."
      oninput="grow(this)"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"
    ></textarea>
    <button class="vbtn" id="vbtn"
      onmousedown="startRec()" onmouseup="stopRec()"
      ontouchstart="startRec(event)" ontouchend="stopRec()">ğŸ™ï¸</button>
    <button class="sbtn" onclick="send()">â¤</button>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USERS = {
  harsh:{pass:'harsh123',name:'Harsh',init:'H'},
  sabu: {pass:'sabu123', name:'Sabu', init:'S'}
};
const ANN = new Date('2022-10-29');

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let who='harsh', me=null;
let msgs  = JSON.parse(localStorage.getItem('sh4_msgs')||'[]');
let pics  = JSON.parse(localStorage.getItem('sh4_pics')||'{}');
let rec=null, recChunks=[];
let activeMenu=null;
let profTarget=null, profTempSrc=null;

// â”€â”€ VIDEO CALL STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// We use PeerJS for WebRTC signalling via the free PeerJS cloud server
// Peer IDs: "sabhar-harsh" and "sabhar-sabu" â€” fixed, so they can always find each other
const PEER_IDS = { harsh:'sabhar-harsh-2024', sabu:'sabhar-sabu-2024' };
let peer=null, currentCall=null, localStream=null;
let micOn=true, camOn=true;
let callTimer=null, callSeconds=0;
let incomingCallObj=null;

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickUser(u){
  who=u;
  document.querySelectorAll('.tab').forEach((t,i)=>
    t.classList.toggle('active',(i===0&&u==='harsh')||(i===1&&u==='sabu')));
  document.getElementById('passIn').value='';
  document.getElementById('errMsg').textContent='';
}

function doLogin(){
  const p=document.getElementById('passIn').value;
  if(p===USERS[who].pass){
    me=who;
    document.getElementById('loginScreen').classList.add('out');
    setTimeout(()=>{
      document.getElementById('chatScreen').classList.add('show');
      calcAnn(); loadPics(); renderAll(); scrollEnd();
      showToast('Welcome back, '+USERS[me].name+' â¤ï¸');
      initPeer();
    },500);
  } else {
    const btn=document.querySelector('.login-btn');
    btn.classList.remove('shake'); void btn.offsetWidth; btn.classList.add('shake');
    document.getElementById('errMsg').textContent='Wrong password ğŸ’” Try again';
    setTimeout(()=>document.getElementById('errMsg').textContent='',3000);
  }
}

function logout(){
  if(peer){peer.destroy();peer=null;}
  me=null;
  document.getElementById('chatScreen').classList.remove('show');
  document.getElementById('loginScreen').classList.remove('out');
  document.getElementById('passIn').value='';
}

// â”€â”€ ANNIVERSARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcAnn(){
  const today=new Date(); today.setHours(0,0,0,0);
  const ann=new Date(ANN); ann.setHours(0,0,0,0);
  document.getElementById('daysCnt').textContent=Math.floor((today-ann)/86400000).toLocaleString();
  const yrs=today.getFullYear()-ann.getFullYear()-(today<new Date(today.getFullYear(),ann.getMonth(),ann.getDate())?1:0);
  document.getElementById('milestone').textContent='ğŸ‰ '+yrs+' beautiful years!';
  let next=new Date(today.getFullYear(),9,29);
  if(next<=today) next=new Date(today.getFullYear()+1,9,29);
  const dtn=Math.ceil((next-today)/86400000);
  const nyr=next.getFullYear()-ann.getFullYear();
  document.getElementById('nextAnn').textContent=dtn===0?'ğŸŠ Happy '+nyr+'th Anniversary!!':'ğŸ€ '+nyr+'th ann. in '+dtn+' days';
}

// â”€â”€ PROFILE PICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPics(){
  ['harsh','sabu'].forEach(u=>{ if(pics[u]) setAv(u,pics[u]); });
}

function setAv(user,src){
  const el=document.getElementById(user==='harsh'?'avHarsh':'avSabu');
  el.innerHTML='<img src="'+src+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  document.querySelectorAll('.av[data-user="'+user+'"]').forEach(av=>{
    av.innerHTML='<img src="'+src+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  });
}

function openProfModal(user){
  profTarget=user; profTempSrc=pics[user]||null;
  document.getElementById('profTitle').textContent=(user==='harsh'?'Harsh':'Sabu\'s')+' Profile Photo';
  const prev=document.getElementById('profPreview');
  if(pics[user]){prev.src=pics[user];prev.style.display='block';}
  else{prev.src='';prev.style.display='none';}
  document.getElementById('profModal').classList.add('show');
}

function chooseProfPic(){ document.getElementById(profTarget==='harsh'?'picInHarsh':'picInSabu').click(); }

function onPicChosen(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    profTempSrc=ev.target.result;
    const prev=document.getElementById('profPreview');
    prev.src=profTempSrc; prev.style.display='block';
  };
  r.readAsDataURL(f);
  e.target.value='';
}

function saveProfPic(){
  if(!profTempSrc){closeProfModal();return;}
  pics[profTarget]=profTempSrc;
  localStorage.setItem('sh4_pics',JSON.stringify(pics));
  setAv(profTarget,profTempSrc);
  closeProfModal(); showToast('Photo saved â¤ï¸');
}

function closeProfModal(){
  document.getElementById('profModal').classList.remove('show');
  profTarget=null; profTempSrc=null;
}

// â”€â”€ WEBRTC / PEER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPeer(){
  const myPeerId = PEER_IDS[me];
  // Destroy existing peer if any
  if(peer){ try{peer.destroy();}catch(e){} peer=null; }

  try {
    peer = new Peer(myPeerId, {
      host: '0.peerjs.com', port: 443, path: '/', secure: true,
      config: { iceServers:[
        {urls:'stun:stun.l.google.com:19302'},
        {urls:'stun:stun1.l.google.com:19302'}
      ]}
    });
  } catch(e) {
    // PeerJS not available (e.g. offline) â€” degrade gracefully
    return;
  }

  peer.on('open', id => console.log('Peer ready:', id));

  peer.on('call', call => {
    incomingCallObj = call;
    const callerUser = me==='harsh' ? 'sabu' : 'harsh';
    // Show incoming call UI
    const inc=document.getElementById('incomingScreen');
    document.getElementById('incName').textContent = USERS[callerUser].name;
    document.getElementById('incAvatarText').textContent = USERS[callerUser].init;
    const incAv = document.getElementById('incAvatar');
    if(pics[callerUser]){
      incAv.innerHTML='<img src="'+pics[callerUser]+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    }
    inc.classList.add('show');
    // Ring tone feel
    playRing();
  });

  peer.on('error', err => {
    console.warn('Peer error:', err.type, err.message);
    if(err.type==='unavailable-id'){
      // ID taken â€” retry with unique suffix
      setTimeout(()=>{
        if(peer){try{peer.destroy();}catch(e){}}
        peer = new Peer(PEER_IDS[me]+'-'+Date.now().toString().slice(-4), {
          host:'0.peerjs.com',port:443,path:'/',secure:true
        });
      },1000);
    }
  });
}

let ringAudio=null;
function playRing(){
  // Create a simple oscillator ring tone
  try {
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    function beep(){
      const o=ctx.createOscillator();
      const g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value=880; g.gain.value=0.3;
      o.start(); o.stop(ctx.currentTime+0.3);
    }
    ringAudio={stop:()=>ctx.close()};
    let i=0;
    const iv=setInterval(()=>{ beep(); if(++i>6) clearInterval(iv); },600);
    ringAudio.interval=iv;
  } catch(e){}
}
function stopRing(){ if(ringAudio){ clearInterval(ringAudio.interval); try{ringAudio.stop();}catch(e){} ringAudio=null; } }

async function startVideoCall(){
  if(!peer||!peer.open){ showToast('Connecting... try again in a moment'); initPeer(); return; }
  const otherUser = me==='harsh'?'sabu':'harsh';
  const otherPeerId = PEER_IDS[otherUser];

  try {
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  } catch(e) {
    document.getElementById('permModal').classList.add('show'); return;
  }

  document.getElementById('localVideo').srcObject = localStream;
  showVcScreen(otherUser, 'Calling...');

  const call = peer.call(otherPeerId, localStream);
  currentCall = call;

  call.on('stream', remoteStream => {
    document.getElementById('remoteVideo').srcObject = remoteStream;
    document.getElementById('vcStatus').classList.add('hidden');
    startCallTimer();
  });

  call.on('close', ()=>endCall());
  call.on('error', ()=>endCall());

  // Timeout if no answer in 30s
  setTimeout(()=>{ if(currentCall&&!document.getElementById('vcStatus').classList.contains('hidden')){ showToast('No answer ğŸ’”'); endCall(); } },30000);
}

async function acceptCall(){
  stopRing();
  document.getElementById('incomingScreen').classList.remove('show');
  if(!incomingCallObj) return;

  try {
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  } catch(e) {
    document.getElementById('permModal').classList.add('show');
    incomingCallObj.close(); incomingCallObj=null; return;
  }

  document.getElementById('localVideo').srcObject = localStream;
  const callerUser = me==='harsh'?'sabu':'harsh';
  showVcScreen(callerUser, 'Connected â¤ï¸');
  document.getElementById('vcStatus').classList.add('hidden');

  incomingCallObj.answer(localStream);
  currentCall = incomingCallObj;
  incomingCallObj = null;

  currentCall.on('stream', remoteStream => {
    document.getElementById('remoteVideo').srcObject = remoteStream;
    document.getElementById('vcStatus').classList.add('hidden');
    startCallTimer();
  });

  currentCall.on('close', ()=>endCall());
  currentCall.on('error', ()=>endCall());
}

function rejectCall(){
  stopRing();
  document.getElementById('incomingScreen').classList.remove('show');
  if(incomingCallObj){ incomingCallObj.close(); incomingCallObj=null; }
}

function showVcScreen(otherUser, statusTxt){
  const otherU = USERS[otherUser];
  document.getElementById('vcStatusName').textContent = otherU.name;
  document.getElementById('vcStatusTxt').textContent  = statusTxt;
  const av = document.getElementById('vcStatusAv');
  document.getElementById('vcStatusAvTxt').textContent = otherU.init;
  if(pics[otherUser]){
    av.innerHTML='<img src="'+pics[otherUser]+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  } else {
    av.innerHTML='<span id="vcStatusAvTxt">'+otherU.init+'</span>';
  }
  document.getElementById('vcStatus').classList.remove('hidden');
  document.getElementById('vcScreen').classList.add('show');
  micOn=true; camOn=true;
  document.getElementById('btnMic').textContent='ğŸ™ï¸';
  document.getElementById('btnCam').textContent='ğŸ“·';
}

function endCall(){
  if(currentCall){try{currentCall.close();}catch(e){} currentCall=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop()); localStream=null;}
  stopRing(); stopCallTimer();
  document.getElementById('vcScreen').classList.remove('show');
  document.getElementById('remoteVideo').srcObject=null;
  document.getElementById('localVideo').srcObject=null;
  document.getElementById('vcStatus').classList.remove('hidden');
}

function toggleMic(){
  micOn=!micOn;
  if(localStream) localStream.getAudioTracks().forEach(t=>t.enabled=micOn);
  document.getElementById('btnMic').textContent=micOn?'ğŸ™ï¸':'ğŸ”‡';
  document.getElementById('btnMic').classList.toggle('muted',!micOn);
}

function toggleCam(){
  camOn=!camOn;
  if(localStream) localStream.getVideoTracks().forEach(t=>t.enabled=camOn);
  document.getElementById('btnCam').textContent=camOn?'ğŸ“·':'ğŸš«';
  document.getElementById('btnCam').classList.toggle('off',!camOn);
}

function startCallTimer(){
  callSeconds=0;
  callTimer=setInterval(()=>{
    callSeconds++;
    const m=String(Math.floor(callSeconds/60)).padStart(2,'0');
    const s=String(callSeconds%60).padStart(2,'0');
    document.getElementById('vcTimer').textContent=m+':'+s;
  },1000);
}
function stopCallTimer(){
  clearInterval(callTimer); callTimer=null;
  document.getElementById('vcTimer').textContent='00:00';
}

// â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save(){ localStorage.setItem('sh4_msgs',JSON.stringify(msgs)); }

function renderAll(){
  const area=document.getElementById('msgs');
  const lbl=area.querySelector('.day-lbl');
  area.innerHTML=''; area.appendChild(lbl);
  msgs.forEach(renderOne);
}

function mkAv(user,isMe){
  const av=document.createElement('div');
  av.className='av '+(isMe?'me-av':'her-av');
  av.dataset.user=user;
  if(pics[user]){
    av.innerHTML='<img src="'+pics[user]+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  } else {
    av.textContent=USERS[user].init;
    av.style.background=isMe?'var(--pink)':'#f0a0b0';
    av.style.color='white';
  }
  return av;
}

function renderOne(m){
  const area=document.getElementById('msgs');
  const isMe=m.sender===me;
  const row=document.createElement('div');
  row.className='msg-row '+(isMe?'me':'her');
  row.dataset.id=m.id;
  const wrap=document.createElement('div'); wrap.className='bwrap';
  const bub=document.createElement('div');
  bub.className='bubble '+(isMe?'me':'her');

  if(m.type==='text'){
    bub.innerHTML=esc(m.text)+'<span class="bt">'+m.time+'</span>';
  } else if(m.type==='image'){
    const safe=m.data.replace(/'/g,"\\'");
    bub.innerHTML='<img src="'+m.data+'" class="bimg" onclick="openLb(\''+safe+'\')"><span class="bt">'+m.time+'</span>';
  } else if(m.type==='video'){
    bub.innerHTML='<video src="'+m.data+'" class="bvid" controls></video><span class="bt">'+m.time+'</span>';
  } else if(m.type==='voice'){
    bub.innerHTML=vHTML(m.data,m.time);
  }

  let lt=0;
  bub.addEventListener('dblclick',()=>reactMsg(m.id));
  bub.addEventListener('touchend',()=>{const n=Date.now();if(n-lt<320)reactMsg(m.id);lt=n;});

  if(isMe){
    let pt=null;
    bub.addEventListener('contextmenu',ev=>{ev.preventDefault();showMenu(m.id,ev.clientX,ev.clientY);});
    bub.addEventListener('touchstart',ev=>{pt=setTimeout(()=>showMenu(m.id,ev.touches[0].clientX,ev.touches[0].clientY),600);},{passive:true});
    bub.addEventListener('touchend',()=>clearTimeout(pt));
    bub.addEventListener('touchmove',()=>clearTimeout(pt));
  }

  wrap.appendChild(bub);
  if(m.react){
    const rd=document.createElement('div'); rd.className='react-dot'; rd.textContent=m.react;
    wrap.appendChild(rd);
  }
  row.appendChild(mkAv(m.sender,isMe));
  row.appendChild(wrap);
  area.appendChild(row);
}

function reactMsg(id){
  const m=msgs.find(x=>x.id===id); if(!m) return;
  m.react=m.react?null:'â¤ï¸'; save(); renderAll(); scrollEnd();
}

function showMenu(id,x,y){
  closeMenu();
  const menu=document.createElement('div');
  menu.className='msg-menu'; menu.id='activeMenuEl';
  const rb=document.createElement('button'); rb.textContent='â¤ï¸  React';
  rb.onclick=()=>{reactMsg(id);closeMenu();};
  const dv=document.createElement('div'); dv.className='divider';
  const db=document.createElement('button'); db.className='del'; db.textContent='ğŸ—‘  Delete';
  db.onclick=()=>{msgs=msgs.filter(m=>m.id!==id);save();renderAll();scrollEnd();showToast('Deleted');closeMenu();};
  menu.appendChild(rb); menu.appendChild(dv); menu.appendChild(db);
  document.body.appendChild(menu); activeMenu=menu;
  let left=x,top=y;
  if(left+155>window.innerWidth) left=window.innerWidth-160;
  if(top+90>window.innerHeight) top=y-95;
  menu.style.left=left+'px'; menu.style.top=top+'px';
  setTimeout(()=>document.addEventListener('click',closeMenu,{once:true}),50);
}
function closeMenu(){if(activeMenu){activeMenu.remove();activeMenu=null;}}

// â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function vHTML(src,time){
  const bars=Array.from({length:13},(_,i)=>'<span style="animation-delay:'+(i*0.08)+'s"></span>').join('');
  const safe=src.replace(/'/g,"\\'");
  return '<div class="vmsg"><button class="vplay" onclick="playV(this,\''+safe+'\')">â–¶</button><div class="vwave">'+bars+'</div></div><span class="bt">'+time+'</span>';
}
function playV(btn,src){const a=new Audio(src);btn.textContent='â¸';a.play();a.onended=()=>btn.textContent='â–¶';}

// â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function send(type='text',data=null){
  const box=document.getElementById('msgBox');
  const txt=box.value.trim();
  if(type==='text'&&!txt) return;
  const m={id:Date.now()+'',sender:me,type,text:type==='text'?txt:null,data,time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),react:null};
  msgs.push(m); save(); renderOne(m); scrollEnd();
  if(type==='text'){box.value='';box.style.height='auto';heartPop();fakeTyping();}
}
function fakeTyping(){const el=document.getElementById('ttext');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2000);}
function scrollEnd(){const a=document.getElementById('msgs');setTimeout(()=>a.scrollTop=a.scrollHeight,60);}

// â”€â”€ FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onFile(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>send(f.type.startsWith('video')?'video':'image',ev.target.result);
  r.readAsDataURL(f); e.target.value='';
}

// â”€â”€ VOICE REC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startRec(e){
  if(e) e.preventDefault();
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    document.getElementById('permModal').classList.add('show'); return;
  }
  try {
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    rec=new MediaRecorder(s); recChunks=[];
    rec.ondataavailable=ev=>recChunks.push(ev.data);
    rec.start();
    document.getElementById('vbtn').classList.add('rec');
  } catch(e){
    document.getElementById('permModal').classList.add('show');
  }
}
function stopRec(){
  if(!rec||rec.state!=='recording') return;
  rec.onstop=()=>{
    const blob=new Blob(recChunks,{type:'audio/webm'});
    const r=new FileReader();
    r.onload=ev=>send('voice',ev.target.result);
    r.readAsDataURL(blob);
    rec.stream.getTracks().forEach(t=>t.stop());
  };
  rec.stop();
  document.getElementById('vbtn').classList.remove('rec');
}

// â”€â”€ EMOJI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleE(){document.getElementById('etray').classList.toggle('show');}
function ei(e){const b=document.getElementById('msgBox');b.value+=e;b.focus();document.getElementById('etray').classList.remove('show');}

// â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLb(src){document.getElementById('lbImg').src=src;document.getElementById('lb').classList.add('show');}
function closeLb(){document.getElementById('lb').classList.remove('show');}
document.getElementById('lb').addEventListener('click',function(e){if(e.target===this)closeLb();});

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function grow(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
function heartPop(){
  const btn=document.querySelector('.sbtn'),rc=btn.getBoundingClientRect();
  ['â¤ï¸','ğŸ’•','ğŸŒ¸'].forEach((em,i)=>{
    setTimeout(()=>{
      const h=document.createElement('div');
      h.className='hpop';h.textContent=em;
      h.style.left=(rc.left+rc.width/2)+'px';h.style.top=(rc.top+rc.height/2)+'px';
      h.style.setProperty('--tx',(Math.random()-.5)*70+'px');
      h.style.setProperty('--ty',-(25+Math.random()*55)+'px');
      document.body.appendChild(h);setTimeout(()=>h.remove(),800);
    },i*80);
  });
}
document.addEventListener('click',e=>{
  if(!e.target.closest('.etray')&&!e.target.closest('.ibtn'))
    document.getElementById('etray').classList.remove('show');
});

// â”€â”€ REQUEST PERMISSIONS ON LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ask for camera + mic immediately when page loads (like WhatsApp/Meet)
(async function requestPermsOnLoad() {
  try {
    // This triggers the browser's native "Allow camera & microphone?" popup
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    // Immediately stop the tracks â€” we just needed the permission grant
    stream.getTracks().forEach(t => t.stop());
    console.log('âœ… Camera & Mic permission granted');
  } catch (err) {
    // User denied or browser blocked â€” show a friendly one-time banner
    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
      showPermBanner();
    } else if (err.name === 'NotFoundError') {
      console.warn('No camera/mic found on this device');
    } else {
      console.warn('Permission request failed:', err.message);
    }
  }
})();

function showPermBanner() {
  // Only show if the banner doesn't already exist
  if (document.getElementById('permBanner')) return;
  const banner = document.createElement('div');
  banner.id = 'permBanner';
  banner.style.cssText = `
    position:fixed; bottom:0; left:0; right:0;
    background:#1a1a1a; color:white;
    padding:16px 20px; z-index:99999;
    font-family:'DM Sans',sans-serif; font-size:.85rem;
    display:flex; align-items:center; gap:12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,.3);
    animation: slideUp .3s ease;
  `;
  // Add keyframe for slideUp
  if (!document.getElementById('bannerStyle')) {
    const sty = document.createElement('style');
    sty.id = 'bannerStyle';
    sty.textContent = `@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}`;
    document.head.appendChild(sty);
  }
  banner.innerHTML = `
    <span style="font-size:1.4rem">ğŸ“·</span>
    <div style="flex:1;line-height:1.5">
      <b style="color:#f5b8c4">Camera & Mic blocked.</b><br>
      Tap the <b style="color:#f5b8c4">ğŸ”’ lock icon</b> in your browser's address bar
      â†’ <b style="color:#f5b8c4">Site settings</b>
      â†’ set Camera & Microphone to <b style="color:#4ade80">Allow</b>
      â†’ reload the page.
    </div>
    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:#aaa;font-size:1.2rem;cursor:pointer;padding:4px;">âœ•</button>
  `;
  document.body.appendChild(banner);
}

// â”€â”€ DEMO MSGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(msgs.length===0){
  msgs=[
    {id:'1',sender:'harsh',type:'text',text:'Hi Sabu! ğŸŒ¹ I made this just for us. Our own private little world.',time:'10:00 AM',react:null},
    {id:'2',sender:'sabu', type:'text',text:'Awww Harsh this is so cute!! I love it â¤ï¸',time:'10:01 AM',react:'â¤ï¸'},
    {id:'3',sender:'harsh',type:'text',text:'2 years down, forever to go ğŸ’•',time:'10:02 AM',react:null},
  ];
  save();
}
</script>
</body>
</html>
