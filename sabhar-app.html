<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Sabhar â¤ï¸</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=Playfair+Display:ital,wght@0,500;1,400&display=swap" rel="stylesheet">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB4IuvlYH48tocU6ul0eyV9VO0pCqPCMnI",
  authDomain: "sabhar-a9a44.firebaseapp.com",
  projectId: "sabhar-a9a44",
  storageBucket: "sabhar-a9a44.appspot.com",
  messagingSenderId: "25127481788",
  appId: "1:25127481788:web:4b53833a738b3a0f5c9b1a"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

window._db = db;
window._fbReady = true;
window._col = collection;
window._addDoc = addDoc;
window._onSnapshot = onSnapshot;
window._query = query;
window._orderBy = orderBy;
window._deleteDoc = deleteDoc;
window._doc = doc;
window._updateDoc = updateDoc;
window._setDoc = setDoc;
window._getDoc = getDoc;
window._serverTimestamp = serverTimestamp;

window.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--pink:#e8637a;--pink-light:#fdeef1;--pink-mid:#f5b8c4;--bg:#fff9fa;--white:#fff;--text:#2d2d2d;--muted:#aaa;--border:#f0e0e4}
body{font-family:'DM Sans',sans-serif;background:var(--bg);height:100dvh;overflow:hidden;color:var(--text)}

/* CONNECTING */
#connectingOverlay{position:fixed;inset:0;background:#fff9fa;z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;transition:opacity .4s}
#connectingOverlay.hide{opacity:0;pointer-events:none}
.spinner{width:44px;height:44px;border:3px solid var(--pink-light);border-top:3px solid var(--pink);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.conn-logo{font-family:'Playfair Display',serif;font-size:2rem;color:var(--pink)}
.conn-txt{font-size:.8rem;color:var(--muted);letter-spacing:1.5px}

/* LOGIN */
#loginScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--white);z-index:100;padding:30px;transition:opacity .5s,transform .5s}
#loginScreen.out{opacity:0;transform:translateY(-18px);pointer-events:none}
.login-logo{font-family:'Playfair Display',serif;font-size:3rem;color:var(--pink);margin-bottom:6px}
.login-tagline{font-size:.78rem;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:44px}
.tab-row{display:flex;background:var(--pink-light);border-radius:12px;padding:4px;width:100%;max-width:320px;margin-bottom:20px;gap:4px}
.tab{flex:1;padding:10px;border:none;border-radius:9px;background:transparent;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#b07080;cursor:pointer;transition:all .2s}
.tab.active{background:var(--white);color:var(--pink);font-weight:500;box-shadow:0 2px 8px rgba(232,99,122,.12)}
.pass-input{width:100%;max-width:320px;padding:14px 18px;border:1.5px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:1rem;color:var(--text);background:var(--white);outline:none;transition:border-color .2s;letter-spacing:4px;margin-bottom:14px;display:block}
.pass-input::placeholder{letter-spacing:1px;color:#ccc}
.pass-input:focus{border-color:var(--pink)}
.login-btn{width:100%;max-width:320px;padding:14px;background:var(--pink);border:none;border-radius:12px;color:white;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:500;cursor:pointer;box-shadow:0 4px 16px rgba(232,99,122,.28);transition:all .2s}
.login-btn:active{transform:scale(.98)}
.err{margin-top:12px;font-size:.82rem;color:var(--pink);font-style:italic;min-height:18px;text-align:center;max-width:320px}
.shake{animation:sh .35s ease}
@keyframes sh{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

/* CHAT */
#chatScreen{display:none;flex-direction:column;height:100dvh;background:var(--bg)}
#chatScreen.show{display:flex}
.header{background:var(--white);border-bottom:1px solid var(--border);padding:12px 16px;flex-shrink:0}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.header-title{font-family:'Playfair Display',serif;font-size:1.35rem;color:var(--pink);font-style:italic}
.header-right{display:flex;align-items:center;gap:8px}
.hbtn{background:none;border:1px solid var(--border);border-radius:8px;font-size:.72rem;color:var(--muted);cursor:pointer;padding:4px 10px}
.vcall-btn{background:linear-gradient(135deg,var(--pink),#f0a0b0);border:none;border-radius:10px;color:white;font-size:.8rem;font-weight:500;cursor:pointer;padding:7px 13px;display:flex;align-items:center;gap:5px;box-shadow:0 3px 10px rgba(232,99,122,.3);font-family:'DM Sans',sans-serif}

/* Profile strip */
.profile-strip{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.profile-item{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;position:relative}
.profile-pic{width:48px;height:48px;border-radius:50%;border:2.5px solid var(--pink-mid);background:var(--pink-light);display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--pink);font-weight:600;overflow:hidden;flex-shrink:0;transition:border-color .2s}
.profile-pic:active{border-color:var(--pink)}
.profile-pic img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.profile-name{font-size:.68rem;color:var(--muted)}
.profile-edit-hint{font-size:.58rem;color:var(--pink-mid)}
.online-badge{position:absolute;top:0;right:0;width:12px;height:12px;border-radius:50%;background:#22c55e;border:2px solid white}
.offline-badge{position:absolute;top:0;right:0;width:12px;height:12px;border-radius:50%;background:#ccc;border:2px solid white}

/* Ann card */
.ann-card{background:linear-gradient(135deg,#fff0f3,#fff8fa);border:1px solid #f5c6d0;border-radius:14px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.ann-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:3px}
.ann-names{font-family:'Playfair Display',serif;font-size:1rem;color:var(--pink);margin-bottom:3px}
.ann-sub{font-size:.72rem;color:#c08090}
.ann-milestone{font-size:.72rem;color:var(--pink);font-weight:500;margin-top:2px}
.ann-right{text-align:right;flex-shrink:0}
.ann-days{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--pink);line-height:1;margin-bottom:2px}
.ann-days-lbl{font-size:.62rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.ann-next{font-size:.68rem;color:var(--pink);margin-top:4px;font-weight:500}

/* Messages */
.msgs{flex:1;overflow-y:auto;padding:14px 12px;display:flex;flex-direction:column;gap:7px;scroll-behavior:smooth}
.msgs::-webkit-scrollbar{width:3px}
.msgs::-webkit-scrollbar-thumb{background:var(--pink-mid);border-radius:2px}
.day-lbl{text-align:center;font-size:.7rem;color:var(--muted);letter-spacing:1px;margin:4px 0 8px}
.msg-row{display:flex;align-items:flex-end;gap:7px;animation:up .22s ease;position:relative}
@keyframes up{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
.msg-row.me{flex-direction:row-reverse}
.av{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;overflow:hidden;border:1.5px solid var(--pink-mid);background:var(--pink-light)}
.av.me-av{border-color:var(--pink)}
.av img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.bwrap{position:relative;max-width:72%}
.bubble{padding:10px 13px;border-radius:16px;font-size:.91rem;line-height:1.5;word-break:break-word;cursor:pointer}
.bubble.me{background:var(--pink);color:white;border-bottom-right-radius:4px}
.bubble.her{background:var(--white);color:var(--text);border:1px solid var(--border);border-bottom-left-radius:4px}
.bt{font-size:.6rem;opacity:.5;display:block;margin-top:3px}
.bubble.me .bt{text-align:right}
.react-dot{position:absolute;bottom:-9px;right:5px;font-size:13px;background:white;border-radius:10px;padding:1px 4px;border:1px solid var(--border);line-height:1.4;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.bimg{max-width:200px;max-height:160px;border-radius:10px;display:block;cursor:pointer;margin-top:3px}
.bvid{max-width:200px;border-radius:10px;display:block;margin-top:3px}
.vmsg{display:flex;align-items:center;gap:8px;min-width:130px}
.vplay{background:rgba(255,255,255,.25);border:none;border-radius:50%;width:28px;height:28px;color:white;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center}
.bubble.her .vplay{background:var(--pink-light);color:var(--pink)}
.vwave{flex:1;height:20px;display:flex;align-items:center;gap:2px}
.vwave span{display:block;width:2px;background:rgba(255,255,255,.55);border-radius:2px;animation:wv 1.1s ease-in-out infinite}
.bubble.her .vwave span{background:var(--pink-mid)}
@keyframes wv{0%,100%{height:3px}50%{height:15px}}

/* MSG MENU */
.msg-menu{position:fixed;z-index:500;background:var(--white);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.12);overflow:hidden;min-width:150px;animation:popIn .15s ease}
@keyframes popIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.msg-menu button{display:block;width:100%;padding:11px 16px;background:none;border:none;text-align:left;font-family:'DM Sans',sans-serif;font-size:.88rem;cursor:pointer;color:var(--text)}
.msg-menu button:active{background:var(--pink-light)}
.msg-menu button.del{color:#d00}
.msg-menu .divider{height:1px;background:var(--border)}

/* Typing */
.typing-bar{padding:3px 14px;min-height:22px;flex-shrink:0}
.ttext{font-size:.73rem;color:var(--muted);font-style:italic;display:none}
.ttext.show{display:block}
.tdots{display:inline-flex;gap:3px;margin-left:4px;vertical-align:middle}
.tdots span{width:4px;height:4px;border-radius:50%;background:var(--pink-mid);display:inline-block;animation:td 1.1s infinite}
.tdots span:nth-child(2){animation-delay:.18s}.tdots span:nth-child(3){animation-delay:.36s}
@keyframes td{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-4px);opacity:1}}

/* Input bar */
.input-bar{background:var(--white);border-top:1px solid var(--border);padding:9px 11px;display:flex;align-items:flex-end;gap:7px;flex-shrink:0}
.ibtn{width:39px;height:39px;border:1.5px solid var(--border);border-radius:11px;background:var(--white);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;flex-shrink:0;transition:background .15s}
.ibtn:active{background:var(--pink-light)}
.tinput{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:20px;font-family:'DM Sans',sans-serif;font-size:.91rem;color:var(--text);background:var(--bg);outline:none;resize:none;min-height:39px;max-height:110px;line-height:1.45;transition:border-color .2s}
.tinput:focus{border-color:var(--pink-mid)}
.tinput::placeholder{color:#ccc}
.vbtn{width:39px;height:39px;border:1.5px solid var(--border);border-radius:11px;background:var(--white);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;flex-shrink:0;user-select:none}
.vbtn.rec{background:#fdeef1;border-color:var(--pink);animation:pulse .9s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(232,99,122,.3)}50%{box-shadow:0 0 0 7px rgba(232,99,122,0)}}
.sbtn{width:39px;height:39px;background:var(--pink);border:none;border-radius:11px;color:white;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(232,99,122,.28);transition:transform .15s}
.sbtn:active{transform:scale(.93)}
#fileIn,#picInHarsh,#picInSabu{display:none}

/* Emoji */
.etray{position:fixed;bottom:65px;left:11px;background:white;border:1px solid var(--border);border-radius:16px;padding:10px 12px;display:none;flex-wrap:wrap;gap:6px;max-width:250px;box-shadow:0 4px 18px rgba(0,0,0,.07);z-index:50}
.etray.show{display:flex}
.ep{background:none;border:none;font-size:21px;cursor:pointer}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUSTOM ROMANTIC VIDEO CALL UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Floating hearts */
.hearts-canvas{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:1}
.fheart{position:absolute;font-size:18px;animation:floatUp linear forwards;pointer-events:none}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1) rotate(-10deg)}100%{opacity:0;transform:translateY(-220px) scale(.2) rotate(10deg)}}

/* Pulse rings around avatar */
.ring-wrap{position:relative;width:150px;height:150px;display:flex;align-items:center;justify-content:center;margin-bottom:36px}
.ring-ring{position:absolute;border-radius:50%;border:2px solid rgba(232,99,122,.35);animation:ringPulse 2s ease-out infinite}
.ring-ring:nth-child(1){width:100%;height:100%;animation-delay:0s}
.ring-ring:nth-child(2){width:138%;height:138%;animation-delay:.5s}
.ring-ring:nth-child(3){width:176%;height:176%;animation-delay:1s}
@keyframes ringPulse{0%{transform:scale(.7);opacity:.9}100%{transform:scale(1);opacity:0}}
.ring-inner-av{position:absolute;width:110px;height:110px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:38px;color:var(--pink);background:rgba(232,99,122,.15);border:3px solid rgba(232,99,122,.5)}
.ring-inner-av img{width:100%;height:100%;object-fit:cover}

/* RINGING SCREEN (outgoing) */
#vcRinging{display:none;position:fixed;inset:0;z-index:800;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#120608 0%,#25101a 50%,#120608 100%)}
#vcRinging.show{display:flex}

/* INCOMING SCREEN */
#vcIncoming{display:none;position:fixed;inset:0;z-index:900;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#0a0510 0%,#1a0a22 50%,#0a0510 100%)}
#vcIncoming.show{display:flex}

.vc-call-name{font-family:'Playfair Display',serif;font-size:1.75rem;color:white;margin-bottom:6px;text-align:center}
.vc-call-tag{font-size:.78rem;color:rgba(255,255,255,.35);letter-spacing:3px;text-transform:uppercase;text-align:center;margin-bottom:8px}
.vc-call-status{font-size:.82rem;color:rgba(232,99,122,.75);letter-spacing:1.5px;text-align:center;margin-bottom:44px;animation:softBlink 1.8s infinite}
@keyframes softBlink{0%,100%{opacity:1}50%{opacity:.25}}

/* Call action buttons */
.vc-actions{display:flex;gap:48px;align-items:center}
.vc-accept-btn{width:74px;height:74px;border-radius:50%;background:radial-gradient(circle,#34d058,#22a745);border:none;font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 0 rgba(52,208,88,.5);animation:acceptGlow 1.6s infinite}
@keyframes acceptGlow{0%,100%{box-shadow:0 6px 24px rgba(52,208,88,.5)}50%{box-shadow:0 6px 40px rgba(52,208,88,.9),0 0 0 14px rgba(52,208,88,.08)}}
.vc-reject-btn{width:74px;height:74px;border-radius:50%;background:radial-gradient(circle,#f05252,#c81e1e);border:none;font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(240,82,82,.5)}
.vc-hangup-btn{width:68px;height:68px;border-radius:50%;background:radial-gradient(circle,#f05252,#c81e1e);border:none;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(240,82,82,.5)}

/* ACTIVE CALL SCREEN */
#vcActive{display:none;position:fixed;inset:0;z-index:800;flex-direction:column;background:#0a0a0a}
#vcActive.show{display:flex}
.vc-videos{flex:1;position:relative;overflow:hidden;background:#111}
#remoteVideo{width:100%;height:100%;object-fit:cover;display:block}
#localVideo{position:absolute;top:14px;right:14px;width:92px;height:134px;border-radius:18px;object-fit:cover;border:2px solid rgba(255,255,255,.2);box-shadow:0 4px 24px rgba(0,0,0,.7);z-index:5;background:#222}
.vc-remote-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;background:linear-gradient(160deg,#120608,#25101a);transition:opacity .6s}
.vc-placeholder-av{width:100px;height:100px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:36px;color:var(--pink);background:rgba(232,99,122,.1);border:2px solid rgba(232,99,122,.25)}
.vc-placeholder-av img{width:100%;height:100%;object-fit:cover}
.vc-placeholder-name{font-family:'Playfair Display',serif;color:rgba(255,255,255,.6);font-size:1.2rem}
.vc-placeholder-status{font-size:.75rem;color:rgba(255,255,255,.25);letter-spacing:2px;animation:softBlink 1.8s infinite}

/* Top gradient overlay */
.vc-top-bar{position:absolute;top:0;left:0;right:0;height:110px;background:linear-gradient(to bottom,rgba(0,0,0,.75),transparent);z-index:6;display:flex;align-items:flex-start;padding:18px 18px 0}
.vc-top-info{display:flex;align-items:center;gap:10px}
.vc-top-av{width:38px;height:38px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600;color:var(--pink);background:rgba(232,99,122,.12);border:1.5px solid rgba(232,99,122,.35)}
.vc-top-av img{width:100%;height:100%;object-fit:cover}
.vc-top-name{font-family:'Playfair Display',serif;color:white;font-size:.95rem;display:block}
.vc-top-timer{font-size:.7rem;color:rgba(255,255,255,.4);letter-spacing:1px;display:block}

/* Love watermark */
.vc-love-mark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Playfair Display',serif;font-size:1rem;color:rgba(232,99,122,.3);text-align:center;pointer-events:none;z-index:2;letter-spacing:2px;transition:opacity .5s}
.vc-love-mark.fade{opacity:0}

/* Bottom controls */
.vc-bottom-bar{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.9) 60%,transparent);padding:24px 20px 40px;z-index:6;display:flex;align-items:center;justify-content:center;gap:18px}
.vc-ctrl{width:56px;height:56px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);transition:all .2s}
.vc-ctrl.muted{background:rgba(255,255,255,.2)}
.vc-ctrl.end-call{background:radial-gradient(circle,#f05252,#c81e1e);box-shadow:0 4px 20px rgba(240,82,82,.6);width:64px;height:64px;font-size:24px}

/* CALL ENDED SCREEN */
#vcEnded{display:none;position:fixed;inset:0;z-index:1000;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#120608,#25101a,#120608)}
#vcEnded.show{display:flex;animation:fadeIn .6s ease}
@keyframes fadeIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.ended-emoji{font-size:64px;margin-bottom:18px;animation:hb .7s ease infinite alternate}
@keyframes hb{from{transform:scale(1)}to{transform:scale(1.18)}}
.ended-h{font-family:'Playfair Display',serif;font-size:1.7rem;color:white;margin-bottom:8px;text-align:center}
.ended-sub{font-size:.85rem;color:rgba(255,255,255,.38);letter-spacing:1px;margin-bottom:10px;text-align:center}
.ended-dur{font-size:.78rem;color:rgba(232,99,122,.65);margin-bottom:44px;text-align:center}
.ended-back{background:rgba(232,99,122,.18);border:1px solid rgba(232,99,122,.35);border-radius:14px;color:rgba(255,255,255,.75);padding:13px 36px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer;letter-spacing:.5px}

/* Profile modal */
.prof-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:999;display:none;align-items:center;justify-content:center;padding:20px}
.prof-modal.show{display:flex}
.prof-box{background:white;border-radius:20px;padding:28px 24px;max-width:320px;width:100%}
.prof-box h3{font-family:'Playfair Display',serif;color:var(--pink);margin-bottom:20px;text-align:center}
.prof-preview{width:100px;height:100px;border-radius:50%;border:3px solid var(--pink-mid);object-fit:cover;display:block;margin:0 auto 16px;background:var(--pink-light)}
.prof-hint{text-align:center;font-size:.78rem;color:var(--muted);margin-bottom:14px}
.prof-btns{display:flex;gap:10px;flex-direction:column}
.prof-choose{background:var(--pink-light);border:1.5px solid var(--pink-mid);border-radius:10px;color:var(--pink);padding:11px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}
.prof-save{background:var(--pink);border:none;border-radius:10px;color:white;padding:11px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}
.prof-close-btn{background:none;border:1px solid var(--border);border-radius:10px;color:var(--muted);padding:11px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}
.prof-saving{text-align:center;font-size:.8rem;color:var(--pink);display:none}

/* Perm modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal-box{background:white;border-radius:20px;padding:28px 24px;max-width:340px;width:100%;text-align:center}
.modal-box h3{font-family:'Playfair Display',serif;color:var(--pink);font-size:1.3rem;margin-bottom:10px}
.modal-box p{font-size:.88rem;color:var(--text);line-height:1.6;margin-bottom:18px}
.modal-steps{text-align:left;font-size:.83rem;color:#555;line-height:2;margin-bottom:20px}
.modal-steps b{color:var(--pink)}
.modal-close{background:var(--pink);border:none;border-radius:10px;color:white;padding:11px 28px;font-family:'DM Sans',sans-serif;font-size:.9rem;cursor:pointer}

/* Lightbox */
#lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center}
#lb.show{display:flex}
#lbImg{max-width:92vw;max-height:88vh;border-radius:12px}
.lbx{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.12);border:none;border-radius:50%;width:38px;height:38px;color:white;font-size:17px;cursor:pointer}

/* Toast */
.toast{position:fixed;top:14px;left:50%;transform:translateX(-50%) translateY(-65px);background:var(--pink);color:white;font-size:.83rem;padding:9px 20px;border-radius:30px;z-index:9999;transition:transform .4s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.hpop{position:fixed;pointer-events:none;z-index:9999;font-size:17px;animation:hp .8s ease forwards}
@keyframes hp{0%{opacity:1;transform:translate(0,0) scale(.4)}60%{opacity:1;transform:translate(var(--tx),var(--ty)) scale(1)}100%{opacity:0;transform:translate(calc(var(--tx)*1.4),calc(var(--ty)*1.4 + 18px)) scale(.5)}}
</style>
</head>
<body>

<!-- Connecting overlay -->
<div id="connectingOverlay">
  <div class="conn-logo">Sabhar â¤ï¸</div>
  <div class="spinner"></div>
  <div class="conn-txt">CONNECTING...</div>
</div>

<!-- Lightbox -->
<div id="lb"><img id="lbImg" src="" alt=""><button class="lbx" onclick="closeLb()">âœ•</button></div>
<div class="toast" id="toast"></div>

<!-- Perm modal -->
<div class="modal-overlay" id="permModal">
  <div class="modal-box">
    <h3>ğŸ“· Allow Camera & Mic</h3>
    <p>To video call, please allow camera and microphone.</p>
    <div class="modal-steps">
      <b>Chrome:</b><br>
      Tap ğŸ”’ in address bar â†’ Site settings â†’ Camera & Mic â†’ <b>Allow</b><br><br>
      <b>Safari:</b><br>
      Settings â†’ Safari â†’ Camera & Mic â†’ <b>Allow</b>
    </div>
    <button class="modal-close" onclick="document.getElementById('permModal').classList.remove('show')">Got it â¤ï¸</button>
  </div>
</div>

<!-- Profile modal -->
<div class="prof-modal" id="profModal">
  <div class="prof-box">
    <h3 id="profTitle">Profile Photo</h3>
    <img class="prof-preview" id="profPreview" src="" alt="">
    <div class="prof-hint">This photo will be visible to your partner â¤ï¸</div>
    <div class="prof-btns">
      <button class="prof-choose" onclick="chooseProfPic()">ğŸ“· Choose Photo</button>
      <button class="prof-save" id="profSaveBtn" onclick="saveProfPic()">Save â¤ï¸</button>
      <button class="prof-close-btn" onclick="closeProfModal()">Cancel</button>
    </div>
    <div class="prof-saving" id="profSaving">Saving to cloud... â³</div>
  </div>
</div>

<!-- RINGING SCREEN (outgoing call) -->
<div id="vcRinging">
  <div class="hearts-canvas" id="ringingHearts"></div>
  <div class="ring-wrap">
    <div class="ring-ring"></div><div class="ring-ring"></div><div class="ring-ring"></div>
    <div class="ring-inner-av" id="ringAv"><span id="ringAvTxt"></span></div>
  </div>
  <div class="vc-call-name" id="ringName"></div>
  <div class="vc-call-tag">Sabhar â¤ï¸</div>
  <div class="vc-call-status">Ringing...</div>
  <div class="vc-actions">
    <button class="vc-hangup-btn" onclick="endCall(true)">ğŸ“µ</button>
  </div>
</div>

<!-- INCOMING CALL SCREEN -->
<div id="vcIncoming">
  <div class="hearts-canvas" id="incomingHearts"></div>
  <div class="ring-wrap">
    <div class="ring-ring"></div><div class="ring-ring"></div><div class="ring-ring"></div>
    <div class="ring-inner-av" id="incAv"><span id="incAvTxt"></span></div>
  </div>
  <div class="vc-call-name" id="incName"></div>
  <div class="vc-call-tag">Sabhar â¤ï¸</div>
  <div class="vc-call-status">is calling you... ğŸ’•</div>
  <div class="vc-actions">
    <button class="vc-accept-btn" onclick="acceptCall()">ğŸ“</button>
    <button class="vc-reject-btn" onclick="rejectCall()">ğŸ“µ</button>
  </div>
</div>

<!-- ACTIVE CALL SCREEN -->
<div id="vcActive">
  <div class="vc-videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="vc-remote-placeholder" id="remotePlaceholder">
      <div class="vc-placeholder-av" id="remoteAv"><span id="remoteAvTxt"></span></div>
      <div class="vc-placeholder-name" id="remoteName"></div>
      <div class="vc-placeholder-status">Connecting...</div>
    </div>
    <div class="hearts-canvas" id="activeHearts"></div>
    <div class="vc-love-mark" id="loveMark">Harsh â¤ï¸ Saburi</div>
    <div class="vc-top-bar">
      <div class="vc-top-info">
        <div class="vc-top-av" id="topAv"><span id="topAvTxt"></span></div>
        <div>
          <span class="vc-top-name" id="topName"></span>
          <span class="vc-top-timer" id="callTimer">00:00</span>
        </div>
      </div>
    </div>
    <div class="vc-bottom-bar">
      <button class="vc-ctrl" id="btnMic" onclick="toggleMic()">ğŸ™ï¸</button>
      <button class="vc-ctrl" id="btnCam" onclick="toggleCam()">ğŸ“·</button>
      <button class="vc-ctrl end-call" onclick="endCall(false)">ğŸ“µ</button>
      <button class="vc-ctrl" onclick="flipCamera()">ğŸ”„</button>
      <button class="vc-ctrl" onclick="sendCallHeart()">â¤ï¸</button>
    </div>
  </div>
</div>

<!-- CALL ENDED SCREEN -->
<div id="vcEnded">
  <div class="ended-emoji">â¤ï¸</div>
  <div class="ended-h">That was beautiful</div>
  <div class="ended-sub">Talk soon, <span id="endedName"></span> ğŸŒ¸</div>
  <div class="ended-dur" id="endedDur"></div>
  <button class="ended-back" onclick="closeEndedScreen()">Back to chat â¤ï¸</button>
</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-logo">Sabhar â¤ï¸</div>
  <div class="login-tagline">just for us</div>
  <div class="tab-row">
    <button class="tab active" onclick="pickUser('harsh')">Harsh ğŸ’™</button>
    <button class="tab" onclick="pickUser('sabu')">Sabu ğŸŒ¸</button>
  </div>
  <input type="password" class="pass-input" id="passIn" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
  <button class="login-btn" onclick="doLogin()">Enter Our Space â¤ï¸</button>
  <div class="err" id="errMsg"></div>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <div class="header">
    <div class="header-top">
      <div class="header-title">Sabhar â¤ï¸</div>
      <div class="header-right">
        <button class="vcall-btn" onclick="startVideoCall()">ğŸ“¹ Video Call</button>
        <button class="hbtn" onclick="logout()">Leave</button>
      </div>
    </div>

    <div class="profile-strip">
      <div class="profile-item" onclick="openProfModal('harsh')">
        <div class="profile-pic" id="avHarsh"><span id="avHarshTxt">H</span></div>
        <div id="harshBadge" class="offline-badge"></div>
        <div class="profile-name">Harsh</div>
        <div class="profile-edit-hint">tap to change</div>
      </div>
      <div style="flex:1;text-align:center">
        <div style="font-size:1.3rem">â¤ï¸</div>
        <div style="font-size:.58rem;color:var(--muted);letter-spacing:1.5px;margin-top:2px">FOREVER</div>
      </div>
      <div class="profile-item" onclick="openProfModal('sabu')">
        <div class="profile-pic" id="avSabu"><span id="avSabuTxt">S</span></div>
        <div id="sabuBadge" class="offline-badge"></div>
        <div class="profile-name">Saburi</div>
        <div class="profile-edit-hint">tap to change</div>
      </div>
    </div>

    <div class="ann-card">
      <div>
        <div class="ann-label">Our Anniversary</div>
        <div class="ann-names">Harsh &amp; Saburi</div>
        <div class="ann-sub">ğŸ“… 29 October 2022</div>
        <div class="ann-milestone" id="milestone"></div>
      </div>
      <div class="ann-right">
        <div class="ann-days" id="daysCnt">â€”</div>
        <div class="ann-days-lbl">days together</div>
        <div class="ann-next" id="nextAnn"></div>
      </div>
    </div>
  </div>

  <div class="msgs" id="msgs">
    <div class="day-lbl">âœ¨ Loading your messages... âœ¨</div>
  </div>

  <div class="typing-bar">
    <span class="ttext" id="ttext">
      <span id="typingName">Sabu</span> is typing
      <span class="tdots"><span></span><span></span><span></span></span>
    </span>
  </div>

  <div class="etray" id="etray">
    <button class="ep" onclick="ei('â¤ï¸')">â¤ï¸</button>
    <button class="ep" onclick="ei('ğŸ˜˜')">ğŸ˜˜</button>
    <button class="ep" onclick="ei('ğŸ’•')">ğŸ’•</button>
    <button class="ep" onclick="ei('ğŸ¥°')">ğŸ¥°</button>
    <button class="ep" onclick="ei('ğŸ˜')">ğŸ˜</button>
    <button class="ep" onclick="ei('ğŸ˜Š')">ğŸ˜Š</button>
    <button class="ep" onclick="ei('ğŸŒ¹')">ğŸŒ¹</button>
    <button class="ep" onclick="ei('ğŸ’‹')">ğŸ’‹</button>
    <button class="ep" onclick="ei('âœ¨')">âœ¨</button>
    <button class="ep" onclick="ei('ğŸ¤—')">ğŸ¤—</button>
    <button class="ep" onclick="ei('ğŸ«¶')">ğŸ«¶</button>
    <button class="ep" onclick="ei('ğŸŒ¸')">ğŸŒ¸</button>
  </div>

  <div class="input-bar">
    <button class="ibtn" onclick="toggleE()">ğŸ˜Š</button>
    <button class="ibtn" onclick="document.getElementById('fileIn').click()">ğŸ“</button>
    <input type="file" id="fileIn" accept="image/*,video/*" onchange="onFile(event)">
    <input type="file" id="picInHarsh" accept="image/*" onchange="onPicChosen(event)">
    <input type="file" id="picInSabu"  accept="image/*" onchange="onPicChosen(event)">
    <textarea class="tinput" id="msgBox" placeholder="Message..."
      oninput="grow(this);onTyping()"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"
    ></textarea>
    <button class="vbtn" id="vbtn"
      onmousedown="startRec()" onmouseup="stopRec()"
      ontouchstart="startRec(event)" ontouchend="stopRec()">ğŸ™ï¸</button>
    <button class="sbtn" onclick="send()">â¤</button>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USERS = {
  harsh:{pass:'harsh123',name:'Harsh',init:'H'},
  sabu: {pass:'sabu123', name:'Sabu',  init:'S'}
};
const ANN = new Date('2022-10-29');

// Jitsi Meet â€” 100% FREE, no account needed!
// We use a fixed permanent room for the couple
const JITSI_ROOM = 'SabharLoveHarshSabu2024';

let who='harsh', me=null;
let profTarget=null, profTempSrc=null;
let rec=null, recChunks=[];
let activeMenu=null;
let unsubMsgs=null, unsubPresence=null, unsubTyping=null;
let typingTimer=null;
let callActive=false,callTimerInterval=null,callSeconds=0;
let incomingCallUnsub=null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIREBASE READY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('firebase-ready', () => {
  setTimeout(()=>document.getElementById('connectingOverlay').classList.add('hide'), 400);
  requestPerms();
});
setTimeout(()=>document.getElementById('connectingOverlay').classList.add('hide'), 6000);

async function requestPerms(){
  try{ const s=await navigator.mediaDevices.getUserMedia({video:true,audio:true}); s.getTracks().forEach(t=>t.stop()); }catch(e){}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickUser(u){
  who=u;
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&u==='harsh')||(i===1&&u==='sabu')));
  document.getElementById('passIn').value='';
  document.getElementById('errMsg').textContent='';
}

function doLogin(){
  const p=document.getElementById('passIn').value;
  if(p===USERS[who].pass){
    me=who;
    document.getElementById('loginScreen').classList.add('out');
    setTimeout(()=>{
      document.getElementById('chatScreen').classList.add('show');
      calcAnn();
      subscribeMessages();
      subscribePresence();
      subscribeTyping();
      subscribeCallSignal();
      setOnline(true);
      loadProfilesFromCloud();
      showToast('Welcome back, '+USERS[me].name+' â¤ï¸');
    },500);
  } else {
    const btn=document.querySelector('.login-btn');
    btn.classList.remove('shake'); void btn.offsetWidth; btn.classList.add('shake');
    document.getElementById('errMsg').textContent='Wrong password ğŸ’” Try again';
    setTimeout(()=>document.getElementById('errMsg').textContent='',3000);
  }
}

async function logout(){
  await setOnline(false);
  if(unsubMsgs){unsubMsgs();unsubMsgs=null;}
  if(unsubPresence){unsubPresence();unsubPresence=null;}
  if(unsubTyping){unsubTyping();unsubTyping=null;}
  if(incomingCallUnsub){incomingCallUnsub();incomingCallUnsub=null;}
  endCall();
  me=null;
  document.getElementById('chatScreen').classList.remove('show');
  document.getElementById('loginScreen').classList.remove('out');
  document.getElementById('passIn').value='';
  document.getElementById('msgs').innerHTML='<div class="day-lbl">âœ¨ Loading your messages... âœ¨</div>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANNIVERSARY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcAnn(){
  const today=new Date(); today.setHours(0,0,0,0);
  const ann=new Date(ANN); ann.setHours(0,0,0,0);
  document.getElementById('daysCnt').textContent=Math.floor((today-ann)/86400000).toLocaleString();
  const yrs=today.getFullYear()-ann.getFullYear()-(today<new Date(today.getFullYear(),ann.getMonth(),ann.getDate())?1:0);
  document.getElementById('milestone').textContent='ğŸ‰ '+yrs+' beautiful years!';
  let next=new Date(today.getFullYear(),9,29);
  if(next<=today) next=new Date(today.getFullYear()+1,9,29);
  const dtn=Math.ceil((next-today)/86400000);
  const nyr=next.getFullYear()-ann.getFullYear();
  document.getElementById('nextAnn').textContent=dtn===0?'ğŸŠ Happy '+nyr+'th Anniversary!!':'ğŸ€ '+nyr+'th ann. in '+dtn+' days';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROFILE PICTURES â€” stored in Firestore
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfilesFromCloud(){
  if(!window._fbReady) return;
  for(const u of ['harsh','sabu']){
    try{
      const snap = await window._getDoc(window._doc(window._db,'profiles',u));
      if(snap.exists() && snap.data().photoURL){
        setAvatar(u, snap.data().photoURL);
      }
    }catch(e){}
  }
  // Subscribe to live profile changes
  ['harsh','sabu'].forEach(u=>{
    window._onSnapshot(window._doc(window._db,'profiles',u), snap=>{
      if(snap.exists() && snap.data().photoURL) setAvatar(u, snap.data().photoURL);
    });
  });
}

function setAvatar(user, src){
  const el=document.getElementById(user==='harsh'?'avHarsh':'avSabu');
  if(src){
    el.innerHTML='<img src="'+src+'" alt="'+user+'">';
  }
  // Also update all message avatars
  document.querySelectorAll('.av[data-user="'+user+'"]').forEach(av=>{
    av.innerHTML='<img src="'+src+'">';
  });
  // Update incoming/vc avatars if relevant
  if(me && user !== me){
    const other=user;
    document.getElementById('incAvatar').innerHTML='<img src="'+src+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    document.getElementById('vcAv').innerHTML='<img src="'+src+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  }
}

function openProfModal(user){
  profTarget=user; profTempSrc=null;
  document.getElementById('profTitle').textContent=(user==='harsh'?'Harsh':'Sabu\'s')+' Profile Photo';
  document.getElementById('profPreview').src='';
  document.getElementById('profPreview').style.display='none';
  document.getElementById('profSaving').style.display='none';
  document.getElementById('profModal').classList.add('show');
}

function chooseProfPic(){
  document.getElementById(profTarget==='harsh'?'picInHarsh':'picInSabu').click();
}

function onPicChosen(e){
  const f=e.target.files[0]; if(!f) return;
  // Resize image to max 400px to keep Firestore doc small
  const img=new Image();
  const url=URL.createObjectURL(f);
  img.onload=()=>{
    const maxSize=400;
    let w=img.width, h=img.height;
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    const canvas=document.createElement('canvas');
    canvas.width=w; canvas.height=h;
    canvas.getContext('2d').drawImage(img,0,0,w,h);
    profTempSrc=canvas.toDataURL('image/jpeg',0.7);
    const prev=document.getElementById('profPreview');
    prev.src=profTempSrc; prev.style.display='block';
    URL.revokeObjectURL(url);
  };
  img.src=url;
  e.target.value='';
}

async function saveProfPic(){
  if(!profTempSrc){closeProfModal();return;}
  if(!window._fbReady){showToast('Not connected yet, try again');return;}
  document.getElementById('profSaving').style.display='block';
  document.getElementById('profSaveBtn').disabled=true;
  try{
    await window._setDoc(window._doc(window._db,'profiles',profTarget),{
      photoURL: profTempSrc,
      updatedAt: window._serverTimestamp()
    });
    setAvatar(profTarget, profTempSrc);
    showToast('Photo saved & shared with partner â¤ï¸');
    closeProfModal();
  }catch(e){
    showToast('Save failed: '+e.message);
  }
  document.getElementById('profSaveBtn').disabled=false;
}

function closeProfModal(){
  document.getElementById('profModal').classList.remove('show');
  document.getElementById('profSaving').style.display='none';
  document.getElementById('profSaveBtn').disabled=false;
  profTarget=null; profTempSrc=null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PRESENCE (online/offline badges)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function setOnline(online){
  if(!me||!window._fbReady) return;
  try{
    await window._setDoc(window._doc(window._db,'presence',me),{
      online, ts: window._serverTimestamp()
    });
  }catch(e){}
}

function subscribePresence(){
  ['harsh','sabu'].forEach(u=>{
    window._onSnapshot(window._doc(window._db,'presence',u), snap=>{
      const badge=document.getElementById(u+'Badge');
      if(!badge) return;
      const online=snap.exists()&&snap.data().online;
      badge.className=online?'online-badge':'offline-badge';
    });
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TYPING INDICATOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTyping(){
  if(!me||!window._fbReady) return;
  clearTimeout(typingTimer);
  window._setDoc(window._doc(window._db,'typing',me),{typing:true,ts:Date.now()}).catch(()=>{});
  typingTimer=setTimeout(()=>{
    window._setDoc(window._doc(window._db,'typing',me),{typing:false,ts:Date.now()}).catch(()=>{});
  },2500);
}

function subscribeTyping(){
  const other=me==='harsh'?'sabu':'harsh';
  unsubTyping=window._onSnapshot(window._doc(window._db,'typing',other), snap=>{
    const el=document.getElementById('ttext');
    if(snap.exists()&&snap.data().typing){
      document.getElementById('typingName').textContent=USERS[other].name;
      el.classList.add('show');
    } else {
      el.classList.remove('show');
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MESSAGES â€” Firestore real-time
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subscribeMessages(){
  if(!window._fbReady){setTimeout(subscribeMessages,500);return;}
  const q=window._query(window._col(window._db,'messages'),window._orderBy('createdAt','asc'));
  unsubMsgs=window._onSnapshot(q, snap=>{
    const area=document.getElementById('msgs');
    area.innerHTML='<div class="day-lbl">âœ¨ Your story begins here âœ¨</div>';
    snap.forEach(d=>renderOne({id:d.id,...d.data()}));
    scrollEnd();
  });
}

async function sendMsg(type='text',data=null){
  const box=document.getElementById('msgBox');
  const txt=box.value.trim();
  if(type==='text'&&!txt) return;
  if(!window._fbReady){showToast('Not connected');return;}
  await window._addDoc(window._col(window._db,'messages'),{
    sender:me, type,
    text:type==='text'?txt:'',
    data:data||'',
    time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
    react:'',
    createdAt:window._serverTimestamp()
  });
  if(type==='text'){box.value='';box.style.height='auto';heartPop();}
  // Stop typing indicator
  window._setDoc(window._doc(window._db,'typing',me),{typing:false,ts:Date.now()}).catch(()=>{});
}

function send(){ sendMsg('text'); }

async function deleteMsg(id){
  if(!window._fbReady) return;
  await window._deleteDoc(window._doc(window._db,'messages',id));
  showToast('Deleted');
}

async function reactMsg(id,current){
  if(!window._fbReady) return;
  await window._updateDoc(window._doc(window._db,'messages',id),{react:current?'':'â¤ï¸'});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER MESSAGES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkAv(user,isMe){
  const av=document.createElement('div');
  av.className='av '+(isMe?'me-av':'her-av');
  av.dataset.user=user;
  // Try to get profile pic from Firestore cache
  const img=document.getElementById(user==='harsh'?'avHarsh':'avSabu').querySelector('img');
  if(img){
    av.innerHTML='<img src="'+img.src+'">';
  } else {
    av.textContent=USERS[user].init;
    av.style.background=isMe?'var(--pink)':'#f0a0b0';
    av.style.color='white';
  }
  return av;
}

function renderOne(m){
  const area=document.getElementById('msgs');
  const isMe=m.sender===me;
  const row=document.createElement('div');
  row.className='msg-row '+(isMe?'me':'her');

  const wrap=document.createElement('div'); wrap.className='bwrap';
  const bub=document.createElement('div');
  bub.className='bubble '+(isMe?'me':'her');

  if(m.type==='text'){
    bub.innerHTML=esc(m.text)+'<span class="bt">'+m.time+'</span>';
  } else if(m.type==='image'){
    const safe=(m.data||'').replace(/'/g,"\\'");
    bub.innerHTML='<img src="'+m.data+'" class="bimg" onclick="openLb(\''+safe+'\')" onerror="this.style.display=\'none\'"><span class="bt">'+m.time+'</span>';
  } else if(m.type==='video'){
    bub.innerHTML='<video src="'+m.data+'" class="bvid" controls></video><span class="bt">'+m.time+'</span>';
  } else if(m.type==='voice'){
    bub.innerHTML=vHTML(m.data,m.time);
  } else if(m.type==='call'){
    bub.innerHTML='ğŸ“¹ '+esc(m.text)+'<span class="bt">'+m.time+'</span>';
  }

  // Double-tap react
  let lt=0;
  bub.addEventListener('dblclick',()=>reactMsg(m.id,m.react));
  bub.addEventListener('touchend',()=>{const n=Date.now();if(n-lt<320)reactMsg(m.id,m.react);lt=n;});

  // Long press = delete menu (own msgs)
  if(isMe){
    let pt=null;
    bub.addEventListener('contextmenu',ev=>{ev.preventDefault();showMenu(m.id,ev.clientX,ev.clientY);});
    bub.addEventListener('touchstart',ev=>{pt=setTimeout(()=>showMenu(m.id,ev.touches[0].clientX,ev.touches[0].clientY),600);},{passive:true});
    bub.addEventListener('touchend',()=>clearTimeout(pt));
    bub.addEventListener('touchmove',()=>clearTimeout(pt));
  }

  wrap.appendChild(bub);
  if(m.react){
    const rd=document.createElement('div');rd.className='react-dot';rd.textContent=m.react;
    wrap.appendChild(rd);
  }
  row.appendChild(mkAv(m.sender,isMe));
  row.appendChild(wrap);
  area.appendChild(row);
}

function showMenu(id,x,y){
  closeMenu();
  const menu=document.createElement('div');menu.className='msg-menu';
  const rb=document.createElement('button');rb.textContent='â¤ï¸  React';rb.onclick=()=>{reactMsg(id,'');closeMenu();};
  const dv=document.createElement('div');dv.className='divider';
  const db=document.createElement('button');db.className='del';db.textContent='ğŸ—‘  Delete';db.onclick=()=>{deleteMsg(id);closeMenu();};
  menu.appendChild(rb);menu.appendChild(dv);menu.appendChild(db);
  document.body.appendChild(menu);activeMenu=menu;
  let left=x,top=y;
  if(left+160>window.innerWidth)left=window.innerWidth-165;
  if(top+90>window.innerHeight)top=y-95;
  menu.style.left=left+'px';menu.style.top=top+'px';
  setTimeout(()=>document.addEventListener('click',closeMenu,{once:true}),50);
}
function closeMenu(){if(activeMenu){activeMenu.remove();activeMenu=null;}}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VIDEO CALL â€” Using Jitsi Meet (100% FREE, no account needed!)
// Signalling via Firestore so partner gets notified
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function subscribeCallSignal(){
  const other=me==='harsh'?'sabu':'harsh';
  incomingCallUnsub=window._onSnapshot(window._doc(window._db,'calls','signal'),snap=>{
    if(!snap.exists())return;
    const data=snap.data();
    if(!data.ts)return;
    const age=Date.now()-(data.ts.toMillis?data.ts.toMillis():Date.now());
    if(age>35000)return;
    if(data.to===me&&data.from===other&&data.status==='calling'&&!callActive){
      // PeerJS handles the actual call stream, Firestore is just backup signal
    }
    if(data.to===other&&data.from===me&&data.status==='rejected'){
      showToast(USERS[other].name+' is busy ğŸ’”');endCall(true);
    }
    if(data.status==='ended'&&callActive){endCall(false);}
  });
}

// PeerJS peer init
function initPeer(){
  if(peer){try{peer.destroy();}catch(e){}}
  const peerId=PEER_IDS[me];
  peer=new Peer(peerId,{
    host:'0.peerjs.com',port:443,path:'/',secure:true,
    config:{iceServers:[
      {urls:'stun:stun.l.google.com:19302'},
      {urls:'stun:stun1.l.google.com:19302'},
      {urls:'stun:stun2.l.google.com:19302'},
      {urls:'stun:global.stun.twilio.com:3478'}
    ]}
  });
  peer.on('call',incomingCall=>{
    const caller=me==='harsh'?'sabu':'harsh';
    pendingCall=incomingCall;
    showIncomingScreen(caller);
  });
  peer.on('error',err=>{
    if(err.type==='unavailable-id'){
      setTimeout(()=>{
        peer=new Peer(peerId+'-'+Math.floor(Math.random()*1000),{host:'0.peerjs.com',port:443,path:'/',secure:true});
      },1000);
    }
  });
}

async function startVideoCall(){
  if(callActive){showToast('Already in a call ğŸ“¹');return;}
  const other=me==='harsh'?'sabu':'harsh';
  let stream;
  try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}},audio:true});}
  catch(e){document.getElementById('permModal').classList.add('show');return;}
  localStream=stream;
  document.getElementById('localVideo').srcObject=stream;
  showRingingScreen(other);
  // Signal via Firestore
  if(window._fbReady){
    await window._setDoc(window._doc(window._db,'calls','signal'),{
      from:me,to:other,status:'calling',ts:window._serverTimestamp()
    }).catch(()=>{});
  }
  // WebRTC call
  if(!peer||!peer.open){initPeer();setTimeout(()=>makeCall(other,stream),2000);}
  else{makeCall(other,stream);}
  // Log in chat
  window._addDoc(window._col(window._db,'messages'),{
    sender:me,type:'call',text:'ğŸ“¹ Started a video call',data:'',
    time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
    react:'',createdAt:window._serverTimestamp()
  }).catch(()=>{});
}

function makeCall(other,stream){
  const call=peer.call(PEER_IDS[other],stream);
  currentCall=call;
  call.on('stream',remoteStream=>{
    document.getElementById('remoteVideo').srcObject=remoteStream;
    document.getElementById('vcRinging').classList.remove('show');
    showActiveScreen(other);
    fadeOutPlaceholder();
  });
  call.on('close',()=>endCall(false));
  call.on('error',()=>endCall(false));
  setTimeout(()=>{
    if(callActive&&document.getElementById('vcRinging').classList.contains('show')){
      showToast('No answer ğŸ’”');endCall(true);
    }
  },30000);
}

function showRingingScreen(other){
  callActive=true;
  setVcAv('ringAv','ringAvTxt',other);
  document.getElementById('ringName').textContent=USERS[other].name;
  document.getElementById('vcRinging').classList.add('show');
  startHearts('ringingHearts');
  startTimer();
}

function showIncomingScreen(caller){
  if(callActive)return;
  setVcAv('incAv','incAvTxt',caller);
  document.getElementById('incName').textContent=USERS[caller].name;
  document.getElementById('vcIncoming').classList.add('show');
  startHearts('incomingHearts');
  playTone();
}

function showActiveScreen(other){
  setVcAv('remoteAv','remoteAvTxt',other);
  setVcAv('topAv','topAvTxt',other);
  document.getElementById('remoteName').textContent=USERS[other].name;
  document.getElementById('topName').textContent=USERS[other].name;
  document.getElementById('vcActive').classList.add('show');
  startHearts('activeHearts');
  setTimeout(()=>document.getElementById('loveMark').classList.add('fade'),4000);
}

function fadeOutPlaceholder(){
  const ph=document.getElementById('remotePlaceholder');
  ph.style.opacity='0';
  setTimeout(()=>ph.style.display='none',600);
}

function setVcAv(elId,txtId,user){
  const el=document.getElementById(elId);
  const src=getAvatarSrc(user);
  if(src){el.innerHTML='<img src="'+src+'">';}
  else{document.getElementById(txtId).textContent=USERS[user].init;}
}

function getAvatarSrc(user){
  const el=document.getElementById(user==='harsh'?'avHarsh':'avSabu');
  const img=el.querySelector('img');return img?img.src:null;
}

async function acceptCall(){
  stopTone();
  document.getElementById('vcIncoming').classList.remove('show');
  if(!pendingCall)return;
  let stream;
  try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:true});}
  catch(e){document.getElementById('permModal').classList.add('show');return;}
  localStream=stream;
  document.getElementById('localVideo').srcObject=stream;
  callActive=true;
  const caller=me==='harsh'?'sabu':'harsh';
  showActiveScreen(caller);
  pendingCall.answer(stream);
  currentCall=pendingCall;pendingCall=null;
  currentCall.on('stream',remoteStream=>{
    document.getElementById('remoteVideo').srcObject=remoteStream;
    fadeOutPlaceholder();
  });
  currentCall.on('close',()=>endCall(false));
  startTimer();
  if(window._fbReady){
    await window._setDoc(window._doc(window._db,'calls','signal'),{
      from:caller,to:me,status:'accepted',ts:window._serverTimestamp()
    }).catch(()=>{});
  }
}

async function rejectCall(){
  stopTone();
  document.getElementById('vcIncoming').classList.remove('show');
  if(pendingCall){pendingCall.close();pendingCall=null;}
  const caller=me==='harsh'?'sabu':'harsh';
  if(window._fbReady){
    await window._setDoc(window._doc(window._db,'calls','signal'),{
      from:me,to:caller,status:'rejected',ts:window._serverTimestamp()
    }).catch(()=>{});
  }
}

async function endCall(silent){
  stopTone();stopHearts();stopTimer();
  const wasConnected=document.getElementById('vcActive').classList.contains('show');
  callActive=false;
  if(currentCall){try{currentCall.close();}catch(e){}currentCall=null;}
  if(pendingCall){try{pendingCall.close();}catch(e){}pendingCall=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
  document.getElementById('remoteVideo').srcObject=null;
  document.getElementById('localVideo').srcObject=null;
  document.getElementById('vcRinging').classList.remove('show');
  document.getElementById('vcIncoming').classList.remove('show');
  document.getElementById('vcActive').classList.remove('show');
  document.getElementById('remotePlaceholder').style.display='flex';
  document.getElementById('remotePlaceholder').style.opacity='1';
  document.getElementById('loveMark').classList.remove('fade');
  if(wasConnected){showEndedScreen();}
  if(!silent&&window._fbReady){
    await window._setDoc(window._doc(window._db,'calls','signal'),{status:'ended',ts:window._serverTimestamp()}).catch(()=>{});
  }
}

function showEndedScreen(){
  document.getElementById('endedName').textContent=USERS[me].name;
  const m=String(Math.floor(callSeconds/60)).padStart(2,'0');
  const s=String(callSeconds%60).padStart(2,'0');
  document.getElementById('endedDur').textContent='Call duration: '+m+':'+s;
  document.getElementById('vcEnded').classList.add('show');
}
function closeEndedScreen(){document.getElementById('vcEnded').classList.remove('show');}

// â”€â”€ Call controls â”€â”€
function toggleMic(){
  micOn=!micOn;
  if(localStream)localStream.getAudioTracks().forEach(t=>t.enabled=micOn);
  document.getElementById('btnMic').textContent=micOn?'ğŸ™ï¸':'ğŸ”‡';
  document.getElementById('btnMic').classList.toggle('muted',!micOn);
}
function toggleCam(){
  camOn=!camOn;
  if(localStream)localStream.getVideoTracks().forEach(t=>t.enabled=camOn);
  document.getElementById('btnCam').textContent=camOn?'ğŸ“·':'ğŸš«';
  document.getElementById('btnCam').classList.toggle('muted',!camOn);
}
async function flipCamera(){
  if(!localStream)return;
  facingMode=facingMode==='user'?'environment':'user';
  try{
    const newStream=await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:false});
    const newVid=newStream.getVideoTracks()[0];
    if(currentCall&&currentCall.peerConnection){
      const sender=currentCall.peerConnection.getSenders().find(s=>s.track&&s.track.kind==='video');
      if(sender)await sender.replaceTrack(newVid);
    }
    localStream.getVideoTracks().forEach(t=>t.stop());
    const combined=new MediaStream([newVid,...localStream.getAudioTracks()]);
    localStream=combined;
    document.getElementById('localVideo').srcObject=combined;
  }catch(e){showToast('Flip not supported on this device');}
}
function sendCallHeart(){
  for(let i=0;i<5;i++)setTimeout(()=>spawnHeart('activeHearts'),i*150);
}

// â”€â”€ Timer â”€â”€
function startTimer(){
  callSeconds=0;
  callTimerInterval=setInterval(()=>{
    callSeconds++;
    const m=String(Math.floor(callSeconds/60)).padStart(2,'0');
    const s=String(callSeconds%60).padStart(2,'0');
    document.getElementById('callTimer').textContent=m+':'+s;
  },1000);
}
function stopTimer(){clearInterval(callTimerInterval);callTimerInterval=null;}

// â”€â”€ Ringtone â”€â”€
let toneInterval=null;
function playTone(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    function note(freq,t,dur){
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=freq;
      g.gain.setValueAtTime(0,ctx.currentTime+t);
      g.gain.linearRampToValueAtTime(.25,ctx.currentTime+t+.05);
      g.gain.linearRampToValueAtTime(0,ctx.currentTime+t+dur-.05);
      o.start(ctx.currentTime+t);o.stop(ctx.currentTime+t+dur);
    }
    function melody(){note(523,.0,.25);note(659,.3,.25);note(784,.6,.25);note(1047,.9,.4);}
    melody();toneInterval=setInterval(melody,2200);
  }catch(e){}
}
function stopTone(){if(toneInterval){clearInterval(toneInterval);toneInterval=null;}}

// â”€â”€ Floating hearts â”€â”€
let heartLoopId=null;
function startHearts(cid){
  function loop(){spawnHeart(cid);heartLoopId=setTimeout(loop,600+Math.random()*1000);}
  loop();
}
function spawnHeart(cid){
  const c=document.getElementById(cid);if(!c)return;
  const emojis=['â¤ï¸','ğŸ’•','ğŸŒ¸','ğŸ’—','âœ¨','ğŸ’–','ğŸ¥°'];
  const h=document.createElement('div');h.className='fheart';
  h.textContent=emojis[Math.floor(Math.random()*emojis.length)];
  h.style.left=(5+Math.random()*88)+'%';
  h.style.bottom='-10px';
  h.style.animationDuration=(2+Math.random()*2.5)+'s';
  c.appendChild(h);setTimeout(()=>h.remove(),5000);
}
function stopHearts(){clearTimeout(heartLoopId);heartLoopId=null;}
  frame.classList.add('show');
  document.getElementById('vcWaiting').style.display='none';
}

async function endCall(){
  callActive=false;
  
  
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VOICE MESSAGES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function vHTML(src,time){
  const bars=Array.from({length:13},(_,i)=>'<span style="animation-delay:'+(i*0.08)+'s"></span>').join('');
  const safe=(src||'').replace(/'/g,"\\'");
  return '<div class="vmsg"><button class="vplay" onclick="playV(this,\''+safe+'\')">â–¶</button><div class="vwave">'+bars+'</div></div><span class="bt">'+time+'</span>';
}
function playV(btn,src){const a=new Audio(src);btn.textContent='â¸';a.play();a.onended=()=>btn.textContent='â–¶';}

async function startRec(e){
  if(e) e.preventDefault();
  try{
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    rec=new MediaRecorder(s);recChunks=[];
    rec.ondataavailable=ev=>recChunks.push(ev.data);
    rec.start();
    document.getElementById('vbtn').classList.add('rec');
  }catch(err){document.getElementById('permModal').classList.add('show');}
}
function stopRec(){
  if(!rec||rec.state!=='recording') return;
  rec.onstop=()=>{
    const blob=new Blob(recChunks,{type:'audio/webm'});
    const r=new FileReader();
    r.onload=ev=>sendMsg('voice',ev.target.result);
    r.readAsDataURL(blob);
    rec.stream.getTracks().forEach(t=>t.stop());
  };
  rec.stop();
  document.getElementById('vbtn').classList.remove('rec');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILE SHARING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onFile(e){
  const f=e.target.files[0]; if(!f) return;
  // Resize images to keep Firestore doc size down
  if(f.type.startsWith('image/')){
    const img=new Image();
    const url=URL.createObjectURL(f);
    img.onload=()=>{
      const maxSize=600;
      let w=img.width,h=img.height;
      if(w>maxSize||h>maxSize){if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}else{w=Math.round(w*maxSize/h);h=maxSize;}}
      const canvas=document.createElement('canvas');
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      sendMsg('image',canvas.toDataURL('image/jpeg',0.7));
      URL.revokeObjectURL(url);
    };
    img.src=url;
  } else {
    const r=new FileReader();
    r.onload=ev=>sendMsg('video',ev.target.result);
    r.readAsDataURL(f);
  }
  e.target.value='';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EMOJI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleE(){document.getElementById('etray').classList.toggle('show');}
function ei(e){const b=document.getElementById('msgBox');b.value+=e;b.focus();document.getElementById('etray').classList.remove('show');}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LIGHTBOX
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLb(src){document.getElementById('lbImg').src=src;document.getElementById('lb').classList.add('show');}
function closeLb(){document.getElementById('lb').classList.remove('show');}
document.getElementById('lb').addEventListener('click',function(e){if(e.target===this)closeLb();});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollEnd(){const a=document.getElementById('msgs');setTimeout(()=>a.scrollTop=a.scrollHeight,80);}
function grow(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function heartPop(){
  const btn=document.querySelector('.sbtn'),rc=btn.getBoundingClientRect();
  ['â¤ï¸','ğŸ’•','ğŸŒ¸'].forEach((em,i)=>{
    setTimeout(()=>{
      const h=document.createElement('div');h.className='hpop';h.textContent=em;
      h.style.left=(rc.left+rc.width/2)+'px';h.style.top=(rc.top+rc.height/2)+'px';
      h.style.setProperty('--tx',(Math.random()-.5)*70+'px');
      h.style.setProperty('--ty',-(25+Math.random()*55)+'px');
      document.body.appendChild(h);setTimeout(()=>h.remove(),800);
    },i*80);
  });
}
document.addEventListener('click',e=>{
  if(!e.target.closest('.etray')&&!e.target.closest('.ibtn'))
    document.getElementById('etray').classList.remove('show');
});

// Keep presence updated every 30s
setInterval(()=>{ if(me) setOnline(true); }, 30000);

// Mark offline on page close
window.addEventListener('beforeunload',()=>{ if(me) setOnline(false); });
</script>
</body>
</html>
